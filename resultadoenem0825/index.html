<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Resultado - Simulado Aberto ENEM Agosto</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

  <style>
    header{margin:0;padding:20px 0;background:#002776;color:#fff;text-align:center}
    body{background:#fafafa}
    h1{margin:0;font-size:24px}
    footer{text-align:center;padding:20px;font-size:14px;color:#888}
    #chartWrap{display:none} /* canvas oculto s√≥ p/ gr√°fico do PDF */

    /* mensagem embutida abaixo da nota */
    .mini-msg{
      margin-top:6px;
      font-size:13px;
      line-height:1.25;
      color:#1565c0;
      background:#e3f2fd;
      border-left:4px solid #1976d2;
      border-radius:4px;
      padding:8px;
      text-align: justify;
      hyphens: auto;
      }

    /* bloco ‚ÄúReda√ß√£o (Total) + Compet√™ncias‚Äù movido para baixo dos textos */
    #blocoRedacao{
      display:none;               /* fica escondido at√© termos dados */
      margin-top:16px;
      background:#f5f5f5;
      border-radius:6px;
      padding:12px 14px;
    }
    #blocoRedacao .item{
      margin:4px 0;
      font-size:15px;
    }

    /* esconder linhas antigas de ‚ÄúReda√ß√£o (Total)‚Äù e ‚ÄúCompet√™ncias‚Äù na tabela */
    tr.hide-row{display:none}

    td .nota{ font-weight:700; font-size:16px; display:inline-block; margin-bottom:6px }
  .mini-msg{
    margin-top:0;              /* j√° temos espa√ßo pela .nota */
    background:#eaf3ff;        /* um pouquinho mais claro */
    color:#1257a6;
    border-left-color:#166bd9;
  }
  /* largura fixa pros <th> ficarem alinhados em telas largas */
  table.striped th{ width:210px }

     #blocoRedacao{
    background: #f7f9fc;
    border: 1px solid #e3e9f5;
    box-shadow: 0 1px 2px rgba(0,0,0,.04);
  }
  #blocoRedacao .item strong{ color:#263238 }

    table.striped td, table.striped th{ padding:10px 14px }
  .card-content{ padding:18px } /* um pouco mais compacto */
    
  </style>
</head>
<body>
  <header>
    <h1>Simulado Aberto ENEM Agosto/2025</h1>
  </header>

  <div class="container" style="max-width:900px; margin-top:28px">
    <h5 class="blue-text text-darken-2">Consultar Resultado</h5>

    <div class="card">
      <div class="card-content">
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="inscricao" type="text" required>
            <label for="inscricao">Inscri√ß√£o</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="cpf" type="text" required placeholder="somente n√∫meros">
            <label for="cpf">CPF</label>
          </div>
        </div>

        <div class="row" style="margin-bottom:0">
          <div class="col s12">
            <button id="btnConsultar" class="btn waves-effect waves-light">Consultar</button>
            <button id="btnPdf" class="btn grey waves-effect waves-light" disabled>Baixar PDF</button>
            <span id="status" class="grey-text text-darken-1" style="margin-left:12px"></span>
          </div>
        </div>

        <div id="msg" style="margin-top:12px; color:#d32f2f"></div>
      </div>
    </div>

    <div id="resultado" style="display:none">
      <div class="card">
        <div class="card-content">
          <span class="card-title" id="alunoNome"></span>

          <table class="striped">
            <tbody>
              <tr><th>Inscri√ß√£o</th><td id="inscOut"></td></tr>
              <tr><th>Unidade</th><td id="unidOut"></td></tr>

              <!-- Notas + mensagens embutidas -->
              <tr><th>LINGUAGENS</th><td id="n_ling"></td></tr>
              <tr><th>HUMANAS</th><td id="n_hum"></td></tr>
              <tr><th>NATUREZA</th><td id="n_nat"></td></tr>
              <tr><th>MATEM√ÅTICA</th><td id="n_mat"></td></tr>

              <!-- Estas duas linhas ficam escondidas: vamos mostrar num bloco mais abaixo -->
              <tr id="row_red_total" class="hide-row"><th>Reda√ß√£o (Total)</th><td id="n_red_total"></td></tr>
              <tr id="row_red_comp"  class="hide-row"><th>Compet√™ncias (C1‚ÄìC5)</th><td id="n_red_comp"></td></tr>

              <tr><th>CLS_G</th><td id="n_CLS_G"></td></tr>
              <tr><th>CLS_U</th><td id="n_CLS_U"></td></tr>
            </tbody>
          </table>

          <!-- Bloco movido: Reda√ß√£o (Total) + Compet√™ncias, logo abaixo das mensagens -->
          <div id="blocoRedacao">
            <div class="item"><strong>Reda√ß√£o (Total):</strong> <span id="out_red_total">-</span></div>
            <div class="item"><strong>Compet√™ncias (C1‚ÄìC5):</strong> <span id="out_red_comp">-</span></div>
          </div>

          <!-- Imagem da reda√ß√£o vem depois -->
          <div style="margin-top:16px">
            <h6 class="blue-text text-darken-2">Imagem da Reda√ß√£o</h6>
            <div id="imgBox"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Canvas escondido para gerar gr√°fico para o PDF -->
    <div id="chartWrap" style="display:none">
      <canvas id="grafico"  width="900" height="420"></canvas>   <!-- comparativo Aluno x M√©dia -->
      <canvas id="graficoC" width="520" height="220"></canvas>   <!-- compet√™ncias C1..C5 -->
    </div>
  </div>

  <footer>simuladoaberto.com - Curso Objetivo Vestibulares</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <script>
  /* ===== CONFIG B√ÅSICA ===== */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwradbKRivZtlC3TAWqqPuIsC1UoM6Lgh53FRsM0Z9GryRZ6EcPAXP6NVj_3KqNwJw3/exec';
  const TEMPLATE_URL = 'https://raw.githubusercontent.com/dilalves/simuladoaberto-site/main/resultadoenem0825/RESULTADO_PADRAO_0825.pdf';

  let ultimoResultado = null;

  document.getElementById('btnConsultar').addEventListener('click', consultar);
  document.getElementById('btnPdf').addEventListener('click', gerarPDF);

  /* ===== CONSULTA ===== */
  async function consultar(){
  const status = document.getElementById('status');
  const msg = document.getElementById('msg');
  const resDiv = document.getElementById('resultado');
  const btnPdf = document.getElementById('btnPdf');

  status.textContent = 'Consultando...';
  msg.textContent = '';
  resDiv.style.display = 'none';
  btnPdf.disabled = true; btnPdf.classList.add('grey');

  const insc = document.getElementById('inscricao').value.replace(/\D/g,'');
  const cpf  = document.getElementById('cpf').value.replace(/\D/g,'');
  if (!insc || cpf.length < 11) { msg.textContent = 'Preencha inscri√ß√£o e CPF v√°lidos.'; status.textContent=''; return; }

  try{
    const url = `${ENDPOINT}?action=resultado&inscricao=${encodeURIComponent(insc)}&cpf=${encodeURIComponent(cpf)}`;
    const r = await fetch(url, { cache:'no-store' });
    const j = await r.json();
    if (!j.ok) { msg.textContent = j.error || 'N√£o encontrado'; status.textContent=''; return; }

    ultimoResultado = j;

    /* === M√âDIAS GLOBAIS (p/ comparativo) === */
    ultimoResultado.medias = normalizeMedias(j.medias);
    
    if (!ultimoResultado.medias) {
      try {
        const rMed = await fetch(`${ENDPOINT}?action=stats`, { cache: 'no-store' });
        if (rMed.ok) {
          const jMed = await rMed.json();
          const medias = normalizeMedias(jMed?.medias ?? jMed ?? null);
          if (medias) ultimoResultado.medias = medias;
        }
      } catch(e) {
        console.warn('Sem m√©dias do endpoint', e);
      }
    }
    console.log('MEDIAS USADAS:', ultimoResultado.medias);
    
    /* === /M√âDIAS === */

    // Cabe√ßalho
    document.getElementById('alunoNome').textContent = (j.aluno && j.aluno.nome) ? j.aluno.nome : `Inscri√ß√£o ${j.inscricao}`;
    document.getElementById('inscOut').textContent = j.inscricao;
    document.getElementById('unidOut').textContent = (j.aluno && j.aluno.unidadeNome) ? j.aluno.unidadeNome : '-';

    const A = j.areas || {};
    const R = j.redacao || {};
    const C = j.classificacao || {};
    const msgs = getMessages(A, R);

    // notas + mensagens (no mesmo <td>)
    setScoreWithMsg('n_ling', A.linguagens, msgs.linguagens);
    setScoreWithMsg('n_hum',  A.humanas,    msgs.humanas);
    setScoreWithMsg('n_nat',  A.natureza,   msgs.natureza);
    setScoreWithMsg('n_mat',  A.matematica, msgs.matematica);

    // classifica√ß√£o
    setText('n_CLS_G', C.cls_g ?? j.cls_g ?? '-');
    setText('n_CLS_U', C.cls_u ?? j.cls_u ?? '-');

    // bloco Reda√ß√£o + Compet√™ncias
    document.getElementById('out_red_total').textContent = val(R.total);
    const comps = [R.c1,R.c2,R.c3,R.c4,R.c5].filter(x=>x!=null).join(' / ') || '-';
    document.getElementById('out_red_comp').textContent  = comps;
    document.getElementById('blocoRedacao').style.display = 'block';

    // Imagem/preview da Reda√ß√£o
    const L = j.links || {};
    montarRedacao(L.imagemRedacao);

    resDiv.style.display = 'block';
    btnPdf.disabled = false; btnPdf.classList.remove('grey');
    status.textContent = '';
  }catch(e){
    msg.textContent = 'Erro ao consultar. Tente novamente.';
    console.error(e);
    status.textContent='';
  }
}


  function setText(id, v){ document.getElementById(id).textContent = (v==null?'-':v); }
  function val(x){ return (x==null?'-':x); }

  // Mostra pontua√ß√£o + caixinha com a mensagem logo abaixo
  function setScoreWithMsg(id, score, message){
    const el = document.getElementById(id);
    const nota = (score==null?'-':score);
    const msgHtml = message ? `<div class="mini-msg">${message}</div>` : '';
    el.innerHTML = `<span class="nota">${nota}</span>${msgHtml}`;
  }

  /* ===== Reda√ß√£o: imagem/iframe + link ===== */
  function montarRedacao(link){
    const box = document.getElementById('imgBox');
    if (!box) return;
    box.innerHTML = '';
    if (!link) return;

    const idMatch1 = String(link).match(/\/file\/d\/([^/]+)\//);
    const idMatch2 = String(link).match(/[?&]id=([^&]+)/);
    const id = idMatch1 ? idMatch1[1] : (idMatch2 ? idMatch2[1] : null);

    const direct  = id ? `https://drive.google.com/uc?id=${id}&export=view`  : link;
    const preview = id ? `https://drive.google.com/file/d/${id}/preview`     : link;
    const view    = id ? `https://drive.google.com/file/d/${id}/view`        : link;

    const img = new Image();
    img.className = 'redacao';
    img.alt = 'Reda√ß√£o';
    img.src = direct;

    img.onerror = () => {
      box.innerHTML = '';
      const ifr = document.createElement('iframe');
      ifr.style.width = '100%';
      ifr.style.height = '820px';
      ifr.style.border = '0';
      ifr.src = preview;
      box.appendChild(ifr);

      const p = document.createElement('p'); p.style.marginTop = '8px';
      const a = document.createElement('a'); a.href = view; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'Abrir no Google Drive';
      p.append('N√£o carregou como imagem? ', a);
      box.appendChild(p);
    };

    img.onload = () => {
      box.appendChild(img);
      const p = document.createElement('p'); p.style.marginTop = '8px';
      const a = document.createElement('a'); a.href = view; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'Abrir no Google Drive';
      p.append('N√£o carregou como imagem? ', a);
      box.appendChild(p);
    };

    box.appendChild(img);
  }

  /* ===== MENSAGENS POR NOTA (mesmo conte√∫do que j√° usamos) ===== */
  function getMessages(A, R){
    const L = A?.linguagens ?? null;
    const H = A?.humanas    ?? null;
    const N = A?.natureza   ?? null;
    const M = A?.matematica ?? null;
    const RT= R?.total      ?? null;

    return {
      linguagens: msgLinguagens(L),
      humanas:    msgHumanas(H),
      natureza:   msgNatureza(N),
      matematica: msgMatematica(M),
      redacao:    msgRedacao(RT)
    };
  }

  function faixa(nota, faixas, msgSemNota){
    if (nota == null) return msgSemNota;
    for (const f of faixas){
      const okMin = nota >= f.min;
      const okMax = f.max == null ? true : nota <= f.max;
      if (okMin && okMax) return f.msg;
    }
    return faixas.at(-1).msg;
  }

  function msgLinguagens(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Linguagens: Voc√™ j√° deu o primeiro passo! Que tal ler mais textos variados, como not√≠cias, charges e cr√¥nicas? A pr√°tica da leitura vai ajudar a interpretar melhor e evoluir nos estudos."},
      {min:400, max:499, msg:"Linguagens: Seu caminho j√° come√ßou! Foque em entender as ideias principais dos textos, sublinhando palavras-chave. Quanto mais contato com a leitura, melhor o desempenho!"},
      {min:500, max:599, msg:"Linguagens: √ìtimo trabalho! Voc√™ est√° no caminho certo. Continue lendo diferentes g√™neros e praticando a interpreta√ß√£o. Discutir ideias tamb√©m aprimora a compreens√£o."},
      {min:600, max:649, msg:"Linguagens: Seu desempenho est√° crescendo! Experimente leituras mais desafiadoras (poesia, artigo de opini√£o). Resolver provas anteriores melhora a compreens√£o de textos."},
      {min:650, max:699, msg:"Linguagens: Incr√≠vel! Seu dom√≠nio de leitura est√° avan√ßado. Explorar obras liter√°rias amplia vocabul√°rio e diferentes pontos de vista."},
      {min:700, max:799, msg:"Linguagens: Parab√©ns! Boa compreens√£o e capacidade cr√≠tica. Continue com leituras complexas e argumentos bem estruturados."},
      {min:800, max:null, msg:"Linguagens: Excepcional! Dom√≠nio alto de linguagem e interpreta√ß√£o. Explore literatura e textos acad√™micos para lapidar a an√°lise cr√≠tica."}
    ], "Linguagens: sem nota registrada.");
  }

  function msgHumanas(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Humanas: Voc√™ j√° come√ßou a construir seu conhecimento em Ci√™ncias Humanas! Que tal explorar mais sobre hist√≥ria, geografia, sociologia e filosofia? Assistir a document√°rios e ler textos variados pode ajudar a entender melhor os temas."},
      {min:400, max:499, msg:"Humanas: √ìtimo come√ßo! Foque em compreender os principais acontecimentos hist√≥ricos e suas conex√µes com o presente. Reflita sobre temas sociais e pol√≠ticos para ampliar sua vis√£o de mundo."},
      {min:500, max:599, msg:"Humanas: Bom trabalho! Seu conhecimento em Ci√™ncias Humanas est√° se fortalecendo. Continue lendo livros e artigos sobre temas hist√≥ricos e sociais. Debater ideias e formar opini√µes embasadas pode ajudar a consolidar seu aprendizado."},
      {min:600, max:649, msg:"Humanas: Muito bem! Voc√™ j√° tem uma boa compreens√£o dos conte√∫dos. Continue relacionando os temas estudados com quest√µes do mundo atual e explore fontes confi√°veis para aprofundar ainda mais seu conhecimento."},
      {min:650, max:699, msg:"Humanas: Parab√©ns! Seu desempenho em Ci√™ncias Humanas mostra que voc√™ domina os temas com profundidade. Continue explorando autores cl√°ssicos e contempor√¢neos para enriquecer ainda mais suas an√°lises."},
      {min:700, max:799, msg:"Humanas: Excelente! Seu racioc√≠nio cr√≠tico e interpreta√ß√£o dos fatos hist√≥ricos e sociais s√£o impressionantes. Continue desenvolvendo sua capacidade anal√≠tica e aprofundando seus conhecimentos sobre geopol√≠tica, economia e filosofia."},
      {min:800, max:null, msg:"Humanas: Fant√°stico! Seu conhecimento em Ci√™ncias Humanas est√° em alto n√≠vel. Sua capacidade de an√°lise cr√≠tica e reflex√£o sobre o mundo √© admir√°vel. Continue explorando diferentes perspectivas e conectando os temas para expandir ainda mais sua vis√£o global."}
    ], "Humanas: sem nota registrada.");
  }

  function msgNatureza(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Natureza: Voc√™ deu o primeiro passo! Explore mais os fen√¥menos naturais e suas aplica√ß√µes. Estudar de forma pr√°tica, fazendo experimentos simples, por exemplo, pode ajudar a entender melhor os conceitos."},
      {min:400, max:499, msg:"Natureza: Voc√™ est√° come√ßando a construir seu conhecimento! Continue focando nas bases e pratique resolvendo quest√µes e experimentos simples. Isso ajudar√° a evoluir ainda mais."},
      {min:500, max:599, msg:"Natureza: Bom progresso! Seu conhecimento em Ci√™ncias da Natureza est√° crescendo. Continue praticando e conectando conceitos ao cotidiano. Resolver quest√µes de provas anteriores e analisar experimentos simples vai ajudar muito!"},
      {min:600, max:649, msg:"Natureza: √ìtimo trabalho! Seu desempenho est√° se destacando. Aprofunde-se mais em t√≥picos desafiadores, leia livros complementares e resolva quest√µes avan√ßadas para impulsionar ainda mais seu aprendizado."},
      {min:650, max:699, msg:"Natureza: Excelente! Seu dom√≠nio dos conceitos est√° √≥timo. Explore mais as aplica√ß√µes pr√°ticas da ci√™ncia, leia materiais complementares e analise experimentos desafiadores para expandir ainda mais seu conhecimento."},
      {min:700, max:799, msg:"Natureza: Parab√©ns! Voc√™ est√° indo muito bem. Aprofunde ainda mais seus estudos, investigue fen√¥menos naturais complexos e resolva quest√µes de n√≠vel avan√ßado. Seu desempenho reflete uma grande capacidade de an√°lise!"},
      {min:800, max:null, msg:"Natureza: Incr√≠vel! Seu conhecimento √© de alto n√≠vel. Sua capacidade de racioc√≠nio cient√≠fico √© excelente. Continue explorando t√≥picos avan√ßados, analisando experimentos complexos e desafiando-se a ir al√©m nos estudos."}
    ], "Natureza: sem nota registrada.");
  }

  function msgMatematica(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Matem√°tica: Voc√™ j√° deu o primeiro passo! Que tal revisar as opera√ß√µes b√°sicas e resolver problemas mais simples? Com mais pr√°tica, voc√™ vai entender melhor os conceitos fundamentais e avan√ßar nos estudos."},
      {min:400, max:499, msg:"Matem√°tica: Voc√™ est√° no caminho certo! Foque nas bases da matem√°tica e procure resolver exerc√≠cios de problemas simples. Revisar f√≥rmulas tamb√©m vai ajudar a melhorar!"},
      {min:500, max:599, msg:"Matem√°tica: Bom trabalho! Seu entendimento de Matem√°tica est√° crescendo. Continue praticando as opera√ß√µes e explore problemas mais complexos. Resolver quest√µes de provas anteriores vai ajudar a consolidar os conceitos."},
      {min:600, max:649, msg:"Matem√°tica: Excelente progresso! Seu desempenho est√° bom, mas pode melhorar ainda mais. Aprofunde-se em √°lgebra e geometria, e resolva quest√µes de n√≠veis mais desafiadores para aprimorar seu racioc√≠nio l√≥gico."},
      {min:650, max:699, msg:"Matem√°tica: √ìtimo desempenho! Voc√™ j√° tem um bom dom√≠nio das habilidades matem√°ticas. Continue praticando √°lgebra e geometria. Tente resolver quest√µes mais dif√≠ceis e desafie-se a estudar novas √°reas da matem√°tica."},
      {min:700, max:799, msg:"Matem√°tica: Parab√©ns! Seu dom√≠nio de Matem√°tica est√° excelente. Continue aprimorando sua habilidade de resolu√ß√£o de problemas, praticando mais exerc√≠cios complexos e explorando t√≥picos mais avan√ßados, como trigonometria e fun√ß√µes."},
      {min:800, max:null, msg:"Matem√°tica: Incr√≠vel! Seu conhecimento de Matem√°tica √© impressionante. Sua capacidade de resolver problemas complexos √© excelente. Continue explorando t√≥picos avan√ßados do ensino m√©dio, como trigonometria, matrizes, probabilidade e estat√≠stica. Resolver desafios e provas mais exigentes vai ajudar voc√™ a se destacar ainda mais!"}
    ], "Matem√°tica: sem nota registrada.");
  }

  function msgRedacao(nota){
    return faixa(nota, [
      {min:-Infinity, max:200, msg:"Reda√ß√£o: N√£o desista! Toda jornada come√ßa com o primeiro passo. Pratique a escrita de textos dissertativos e analise reda√ß√µes nota 1000 para entender melhor a estrutura!"},
      {min:200, max:299, msg:"Reda√ß√£o: Voc√™ est√° progredindo! Foque na estrutura do texto e na sua linha de racioc√≠nio. Ler e escrever com frequ√™ncia vai ajudar a melhorar!"},
      {min:300, max:399, msg:"Reda√ß√£o: Bom come√ßo! Tente desenvolver melhor seus argumentos e ampliar seu repert√≥rio cultural. Leia editoriais, not√≠cias e artigos de opini√£o para fortalecer suas ideias."},
      {min:400, max:499, msg:"Reda√ß√£o: Seu texto tem potencial! Aprofundar sua argumenta√ß√£o e apresentar uma boa proposta de interven√ß√£o, vi√°vel e coerente com os argumentos apresentados, ajudar√° a elevar sua nota."},
      {min:500, max:599, msg:"Reda√ß√£o: Bom trabalho! Voc√™ j√° compreende bem a estrutura da reda√ß√£o. Agora, foque na progress√£o textual e no aprimoramento da proposta de interven√ß√£o, que deve conter: agente, a√ß√£o, modo/meio, efeito/finalidade e detalhamento."},
      {min:600, max:699, msg:"Reda√ß√£o: Muito bem! Sua reda√ß√£o est√° bem desenvolvida. Continue refinando a argumenta√ß√£o e explorando refer√™ncias para tornar seu texto ainda mais aprimorado, apresentando uma proposta de interven√ß√£o vi√°vel e coerente com os argumentos apresentados."},
      {min:700, max:799, msg:"Reda√ß√£o: Parab√©ns! Sua escrita √© clara e bem organizada. Para alcan√ßar um n√≠vel ainda mais alto, busque aprofundar a an√°lise cr√≠tica e verifique se sua proposta de interven√ß√£o apresenta os seguintes elementos: agente, a√ß√£o, modo/meio, efeito/finalidade, detalhamento."},
      {min:800, max:899, msg:"Reda√ß√£o: Excelente! Sua argumenta√ß√£o e dom√≠nio da escrita s√£o de alto n√≠vel. Continue praticando para alcan√ßar a nota m√°xima!"},
      {min:900, max:null, msg:"Reda√ß√£o: Fant√°stico! Sua reda√ß√£o demonstra dom√≠nio total da estrutura, argumenta√ß√£o e coes√£o. Seu n√≠vel de escrita √© digno de nota m√°xima. Continue se aprimorando e inspirando outros com seu talento!"}
    ], "Reda√ß√£o: sem nota registrada.");
  }

    function msgC1(nota){
  return faixa(nota, [
    {min:0,   max:99,  msg:"C1: Texto com muitos desvios gramaticais e de conven√ß√µes da escrita, comprometendo a compreens√£o."},
    {min:100, max:129, msg:"C1: Texto apresenta alguns desvios de pontua√ß√£o, grafia e morfossintaxe, com comprometimento parcial da estrutura."},
    {min:130, max:149, msg:"C1: Dom√≠nio razo√°vel da norma padr√£o, ainda com desvios que n√£o comprometem a compreens√£o global."},
    {min:150, max:169, msg:"C1: Bom dom√≠nio da modalidade escrita formal, com poucos desvios gramaticais e de conven√ß√µes."},
    {min:170, max:189, msg:"C1: √ìtimo dom√≠nio da modalidade escrita formal; eventuais desvios s√£o raros e n√£o afetam a qualidade do texto."},
    {min:190, max:null,msg:"C1: Excelente dom√≠nio da modalidade escrita formal, com plena adequa√ß√£o √†s conven√ß√µes da escrita."}
  ], "C1: sem nota registrada.");
}

function msgC2(nota){
  return faixa(nota, [
    {min:0,   max:99,  msg:"C2: Texto tangencia o tema ou apresenta argumenta√ß√£o incoerente/insuficiente, com pouco repert√≥rio."},
    {min:100, max:129, msg:"C2: Desenvolvimento limitado do tema, com argumenta√ß√£o previs√≠vel ou pouco consistente."},
    {min:130, max:149, msg:"C2: Desenvolve o tema com coer√™ncia parcial e repert√≥rio suficiente, ainda com limita√ß√µes de aprofundamento."},
    {min:150, max:169, msg:"C2: Desenvolvimento consistente do tema, com uso adequado de repert√≥rio sociocultural."},
    {min:170, max:189, msg:"C2: Argumenta√ß√£o consistente e fluente, articulada ao projeto do texto, com repert√≥rio produtivo."},
    {min:190, max:null,msg:"C2: Excelente desenvolvimento do tema, com autoria marcada e repert√≥rio diversificado, plenamente adequado ao g√™nero."}
  ], "C2: sem nota registrada.");
}

function msgC3(nota){
  return faixa(nota, [
    {min:0,   max:99,  msg:"C3: Apresenta informa√ß√µes desconexas e pouco relacionadas ao ponto de vista."},
    {min:100, max:129, msg:"C3: Organiza√ß√£o incipiente; argumentos previs√≠veis e pouco articulados."},
    {min:130, max:149, msg:"C3: Em defesa de um ponto de vista, apresenta informa√ß√µes relacionadas ao tema, de forma organizada, com ind√≠cios de autoria."},
    {min:150, max:169, msg:"C3: Seleciona e organiza informa√ß√µes/argumentos de forma consistente, com autoria e progress√£o."},
    {min:170, max:189, msg:"C3: Argumentos relevantes e bem articulados, com boa progress√£o e consist√™ncia."},
    {min:190, max:null,msg:"C3: Sele√ß√£o e organiza√ß√£o exemplares; argumentos originais e plenamente articulados em defesa do ponto de vista."}
  ], "C3: sem nota registrada.");
}

function msgC4(nota){
  return faixa(nota, [
    {min:0,   max:99,  msg:"C4: Grande dificuldade em articular as partes do texto, comprometendo a coes√£o."},
    {min:100, max:129, msg:"C4: Articula de forma mediana, com inadequa√ß√µes/desvios e repert√≥rio coesivo pouco diversificado."},
    {min:130, max:149, msg:"C4: Articula√ß√£o adequada na maior parte do texto, embora ainda ocorram alguns desvios de coes√£o."},
    {min:150, max:169, msg:"C4: Boa articula√ß√£o entre as partes do texto, com poucos desvios e uso variado de recursos coesivos."},
    {min:170, max:189, msg:"C4: √ìtima articula√ß√£o textual; repert√≥rio coesivo diversificado, com raras inadequa√ß√µes."},
    {min:190, max:null,msg:"C4: Excelente articula√ß√£o; repert√≥rio amplo de mecanismos lingu√≠sticos e coesivos, sem inadequa√ß√µes relevantes."}
  ], "C4: sem nota registrada.");
}

function msgC5(nota){
  return faixa(nota, [
    {min:0,   max:99,  msg:"C5: Proposta de interven√ß√£o insuficiente, inadequada ou pouco relacionada ao problema abordado."},
    {min:100, max:129, msg:"C5: Proposta incipiente, pouco detalhada e n√£o plenamente articulada ao desenvolvimento do texto."},
    {min:130, max:149, msg:"C5: Proposta bem elaborada e articulada ao tema, ainda sem detalhamento suficiente."},
    {min:150, max:169, msg:"C5: Proposta bem elaborada, articulada e consistente; atende ao problema discutido."},
    {min:170, max:189, msg:"C5: Proposta completa e abrangente, bem detalhada e vi√°vel, respeitando os direitos humanos."},
    {min:190, max:null,msg:"C5: Proposta completa, detalhada e plenamente articulada, com respeito aos direitos humanos."}
  ], "C5: sem nota registrada.");
}

function getFeedbackCompetencias(R){
  return {
    c1: msgC1(R?.c1 ?? null),
    c2: msgC2(R?.c2 ?? null),
    c3: msgC3(R?.c3 ?? null),
    c4: msgC4(R?.c4 ?? null),
    c5: msgC5(R?.c5 ?? null),
  };
}

    

  //* ===== PDF (pdf-lib) com template + comparativo + mini C1..C5 ===== */
  async function gerarPDF(){
    if (!ultimoResultado) return;
  
    const { PDFDocument, StandardFonts } = PDFLib;
  
    // abre template do fundo
    let tplPdf = null;
    try{
      const ab = await fetch(TEMPLATE_URL, { cache:'no-store' }).then(r => r.arrayBuffer());
      tplPdf = await PDFDocument.load(ab);
    }catch(e){
      console.warn('N√£o consegui carregar TEMPLATE_URL; usando branco.', e);
    }
  
    const doc  = await PDFDocument.create();
    const font = await doc.embedFont(StandardFonts.Helvetica);
  
    // ======== P√ÅGINA 1 ========
    let page1;
    if (tplPdf){
      const [tpl1] = await doc.copyPages(tplPdf, [0]);
      page1 = doc.addPage(tpl1);
    } else {
      page1 = doc.addPage([595.28, 841.89]);
    }
    setPdfContext(doc, page1, font);
  
    const LEFT = 48, GAP = 14, TOP1 = page1.getHeight() - 160;
    let y = TOP1;
  
    const j  = ultimoResultado;
    const A  = j.areas || {};
    const R  = j.redacao || {};
    const C  = j.classificacao || {};
    const nome = (j.aluno && j.aluno.nome) || '-';
    const unid = (j.aluno && j.aluno.unidadeNome) || '-';
  
    // cabe√ßalho
    drawTextLine('Resultado ENEM', LEFT, y + 18, 16);
    drawTextLine(`Aluno: ${nome}`,            LEFT, y, 12); y -= GAP;
    drawTextLine(`Inscri√ß√£o: ${j.inscricao}`, LEFT, y, 12);
    drawTextLine(`Unidade: ${unid}`,          LEFT + 220, y, 12); y -= GAP;
  
    // notas em tabela (valores alinhados)
    y = drawScoreTableCentered(A, C, y);   // devolve o novo Y logo abaixo da tabela

  
    // gr√°fico comparativo grande
    try{
      const medias = normalizeMedias(j.medias ?? ultimoResultado.medias ?? null);
      const urlComp = await makeChartImageComparativo(A, medias);
      if (urlComp){
        const png = await doc.embedPng(dataURLtoBytes(urlComp));
        const W = page1.getWidth() - LEFT*2;
        const H = 210;
        page1.drawImage(png, { x: LEFT, y: y - H, width: W, height: H });
        y -= (H + 16);
      }
    }catch(e){ console.warn('comparativo', e); }

    // mensagens (somente das √°reas)
    const msgs = getMessages(A, R);
    _pdf_ctx.y = y;
    drawBullet(msgs.linguagens, 12, 'justify');
    drawBullet(msgs.humanas,    12, 'justify');
    drawBullet(msgs.natureza,   12, 'justify');
    drawBullet(msgs.matematica, 12, 'justify');
  
    // ======== P√ÅGINA 2 (Reda√ß√£o) ========
    let page2;
    if (tplPdf){
      const [tpl2] = await doc.copyPages(tplPdf, [0]); // copia de novo
      page2 = doc.addPage(tpl2);
    } else {
      page2 = doc.addPage([595.28, 841.89]);
    }
    setPdfContext(doc, page2, font);
  
    const TOP2 = page2.getHeight() - 160;
    let y2 = TOP2;
  
    drawTextLine('Reda√ß√£o', LEFT, y2 + 18, 16);
    drawTextLine(`Aluno: ${nome}`,            LEFT, y2, 12); y2 -= GAP;
    drawTextLine(`Inscri√ß√£o: ${j.inscricao}`, LEFT, y2, 12); y2 -= GAP;
  
    // nota total + compet√™ncias em linha
    const comps = [R.c1, R.c2, R.c3, R.c4, R.c5].map(x=>x??'-').join(' / ');
    drawTextLine(`Nota total: ${R.total ?? '-'}`,       LEFT, y2, 12); y2 -= GAP;
    drawTextLine(`Compet√™ncias (C1‚ÄìC5): ${comps}`,      LEFT, y2, 12); y2 -= GAP + 6;
  
    // gr√°fico C1..C5 grande
    try{
      const urlC = await makeChartImageCompetencias(R);
      if (urlC){
        const pngC = await doc.embedPng(dataURLtoBytes(urlC));
        const Wc = page2.getWidth() - LEFT*2;
        const Hc = 200;
        page2.drawImage(pngC, { x: LEFT, y: y2 - Hc, width: Wc, height: Hc });
        y2 -= (Hc + 16);
      }
    }catch(e){ console.warn('competencias', e); }
  
    // mensagem da Reda√ß√£o
    const msgs2 = getMessages(A, R);
    _pdf_ctx.y = y2;
    drawBullet(msgs2.redacao, 12);

    // d√° um respiro generoso e garante espa√ßo na p√°gina
    const gap = Math.round(12 * 1.5);   // ~18px
    _pdf_ctx.y -= gap;
    ensureSpace(1, 12);                  // previne cortar no rodap√©
    
    drawTextLine('Observa√ß√µes por compet√™ncia', _pdf_ctx.MARGIN_X, _pdf_ctx.y - 14, 12, [0.13,0.16,0.20]);
    _pdf_ctx.y -= Math.round(12 * 0.75); // mais um espacinho abaixo do t√≠tulo
        
    _pdf_ctx.y -= 10;  // üëà mais folga ainda antes de iniciar os bullets
    
    // feedback por compet√™ncia
    const fbc = getFeedbackCompetencias(R);
    drawBullet(fbc.c1, 12);
    drawBullet(fbc.c2, 12);
    drawBullet(fbc.c3, 12);
    drawBullet(fbc.c4, 12);
    drawBullet(fbc.c5, 12);
  
    // baixa
    const bytes = await doc.save();
    const blob  = new Blob([bytes], { type:'application/pdf' });
    const a     = document.createElement('a');
    a.href      = URL.createObjectURL(blob);
    a.download  = `resultado_ENEM_${j.inscricao}.pdf`;
    a.click();
  }

  /* ===== helpers gerais ===== */
  function val(x){ return (x==null?'-':x); }
  function dataURLtoBytes(dataURL){
    const base64 = dataURL.split(',')[1];
    const bin = atob(base64); const len = bin.length;
    const bytes = new Uint8Array(len);
    for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
    return bytes;
  }

  async function makeChartImage(A, R){
    const el = document.getElementById('grafico');
    if (!el) return null;
    if (window._chartInst) { window._chartInst.destroy(); }

    const labels = ['LING', 'HUM', 'NAT', 'MAT', 'RED'];
    const data = [A.linguagens ?? null, A.humanas ?? null, A.natureza ?? null, A.matematica ?? null, R.total ?? null];

    window._chartInst = new Chart(el.getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ label:'Notas', data }] },
      options: { responsive: false, animation: false, scales: { y: { suggestedMin: 0, suggestedMax: 1000 } } }
    });

    await new Promise(r=>setTimeout(r, 50));
    return el.toDataURL('image/png');
  }

  /* ===== Helpers de composi√ß√£o de texto no PDF (pdf-lib) ===== */
  let _pdf_ctx = { doc:null, page:null, font:null, y:0, MARGIN_X:40, MARGIN_BOTTOM:40 };

  function setPdfContext(doc, page, font){
    _pdf_ctx = { ..._pdf_ctx, doc, page, font, y: page.getHeight() - 40 };
  }

  function drawTextLine(txt, x, y, size=12, color=[0,0,0]){
    const { page, font } = _pdf_ctx;
    page.drawText(String(txt||''), { x, y, size, font, color: PDFLib.rgb(...color) });
  }

  function contentWidth(){ return _pdf_ctx.page.getWidth() - _pdf_ctx.MARGIN_X*2; }

  function splitIntoLines(text, size=12, maxWidth=contentWidth()){
    const { font } = _pdf_ctx;
    const words = String(text||'').trim().split(/\s+/);
    const lines = [];
    let line = '';
    for (const w of words){
      const probe = line ? line + ' ' + w : w;
      if (font.widthOfTextAtSize(probe, size) <= maxWidth){
        line = probe;
      } else {
        if (line) lines.push(line);
        let rest = w;
        while (font.widthOfTextAtSize(rest, size) > maxWidth && rest.length>1){
          let cut = rest.length-1;
          while (cut>1 && font.widthOfTextAtSize(rest.slice(0,cut), size) > maxWidth) cut--;
          lines.push(rest.slice(0,cut));
          rest = rest.slice(cut);
        }
        line = rest;
      }
    }
    if (line) lines.push(line);
    return lines;
  }

  function ensureSpace(linesCount, size=12){
    const lineHeight = Math.round(size*1.25);
    const need = linesCount*lineHeight + 6;
    if (_pdf_ctx.y - need < _pdf_ctx.MARGIN_BOTTOM){
      const { doc, page } = _pdf_ctx;
      const next = doc.addPage([page.getWidth(), page.getHeight()]);
      _pdf_ctx.page = next;
      _pdf_ctx.y = next.getHeight() - 40;
    }
  }

  function drawParagraph(text, size=12, indentLeft=0, align='left'){
    const lineH = Math.round(size*1.25);
    const maxW  = contentWidth() - indentLeft;
    const lines = splitIntoLines(text, size, maxW);
    ensureSpace(lines.length, size);
  
    const x0 = _pdf_ctx.MARGIN_X + indentLeft;
    lines.forEach((ln, i) => {
      _pdf_ctx.y -= lineH;
      const isLast = i === lines.length - 1;
      if (align === 'justify' && !isLast) {
        drawJustifiedLine(ln, x0, _pdf_ctx.y, size, maxW);
      } else {
        drawTextLine(ln, x0, _pdf_ctx.y, size);
      }
    });
  }
  
  function drawBullet(text, size=12, align='left'){
    const bullet = '‚Ä¢ ';
    const bW = _pdf_ctx.font.widthOfTextAtSize(bullet, size);
    const lineH = Math.round(size*1.25);
    const maxW  = contentWidth() - bW;
    const lines = splitIntoLines(text, size, maxW);
    ensureSpace(lines.length, size);
  
    // primeira linha: desenha bolinha e justifica s√≥ o texto
    _pdf_ctx.y -= lineH;
    drawTextLine(bullet, _pdf_ctx.MARGIN_X, _pdf_ctx.y, size);
    if (align === 'justify' && lines.length > 1){
      drawJustifiedLine(lines[0], _pdf_ctx.MARGIN_X + bW, _pdf_ctx.y, size, maxW);
    } else {
      drawTextLine(lines[0], _pdf_ctx.MARGIN_X + bW, _pdf_ctx.y, size);
    }
  
    // demais linhas (sem o bullet)
    for (let i=1;i<lines.length;i++){
      _pdf_ctx.y -= lineH;
      const isLast = i === lines.length - 1;
      if (align === 'justify' && !isLast){
        drawJustifiedLine(lines[i], _pdf_ctx.MARGIN_X + bW, _pdf_ctx.y, size, maxW);
      } else {
        drawTextLine(lines[i], _pdf_ctx.MARGIN_X + bW, _pdf_ctx.y, size);
      }
    }
  }
// gr√°fico comparativo: 4 √°reas (Aluno x M√©dia)
async function makeChartImageComparativo(A, medias){
  const el = document.getElementById('grafico');
  if (!el) return null;

  const restore = useOffscreenCanvas();
  if (window._chartInst) window._chartInst.destroy();

  const labels = ['LING', 'HUM', 'NAT', 'MAT'];
  const aluno  = [A.linguagens ?? null, A.humanas ?? null, A.natureza ?? null, A.matematica ?? null];

  const datasets = [{ label:'Aluno', data: aluno }];

  const hasAnyMedia =
    medias && [medias.linguagens, medias.humanas, medias.natureza, medias.matematica]
      .some(v => v != null && Number.isFinite(Number(v)));

  if (hasAnyMedia){
    datasets.push({
      label:'M√©dia',
      data:[
        medias.linguagens ?? null,
        medias.humanas    ?? null,
        medias.natureza   ?? null,
        medias.matematica ?? null
      ]
    });
  }

   window._chartInst = new Chart(el.getContext('2d'), {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: false,
      animation: false,
      scales: { y: { suggestedMin: 0, suggestedMax: 1000 } },
      plugins: {
        legend: { display: true, position: 'top' },
        chartValueLabels: { formatter: v => v.toFixed(2) } // üëà 2 casas
      }
    }
  });

  window._chartInst.update();
  await new Promise(r => requestAnimationFrame(r));
  await new Promise(r => setTimeout(r, 100));

  const url = el.toDataURL('image/png');
  window._chartInst.destroy();
  restore();
  return url;
}


// ‚Äî‚Äî‚Äî Compet√™ncias C1..C5 (com r√≥tulos) ‚Äî‚Äî‚Äî
async function makeChartImageCompetencias(R){
  const c = document.getElementById('graficoC');
  if (!c) return null;

  const restore = useOffscreenCanvas();
  if (window._chartInstC) window._chartInstC.destroy();

  const labels = ['C1','C2','C3','C4','C5'];
  const data   = [R.c1, R.c2, R.c3, R.c4, R.c5].map(x => x ?? null);

  window._chartInstC = new Chart(c.getContext('2d'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Compet√™ncias', data }] },
    options: {
      responsive: false,
      animation: false,
      layout: { padding: { top: 12 } },               // folga no topo
      scales: {
        y: {
          suggestedMin: 0,
          suggestedMax: 210,                           // sobe o teto p/ n√£o cortar ‚Äú200‚Äù
          grace: 10,                                   // mais um respiro
          ticks: { stepSize: 20 }
        }
      },
      plugins: {
        legend: { display: false },
        chartValueLabels: { formatter: (v) => String(Math.round(v)) }
      }
    },
    plugins: [chartValueLabels]
  });

  window._chartInstC.update();
  await new Promise(r => requestAnimationFrame(r));
  await sleep(80);

  const url = c.toDataURL('image/png');
  window._chartInstC.destroy();
  restore();
  return url;
}

// Plugin: r√≥tulos nas barras com formata√ß√£o customiz√°vel
// Plugin √öNICO (com guarda) ‚Äî evita redeclara√ß√£o e j√° registra globalmente
if (!window.chartValueLabels) {
  window.chartValueLabels = {
    id: 'chartValueLabels',
    afterDatasetsDraw(chart, _args, pluginOptions) {
      const { ctx, chartArea:{ top } = { top: 0 } } = chart;
      const fmt = pluginOptions?.formatter || (v => String(v));

      ctx.save();
      ctx.font = '10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';

      chart.data.datasets.forEach((ds, di) => {
        const meta = chart.getDatasetMeta(di);
        meta.data.forEach((el, i) => {
          const n = Number(ds.data[i]);
          if (!Number.isFinite(n)) return;
          let y = el.y - 4;
          if (y < top + 8) y = top + 8;   // evita cortar r√≥tulo no topo
          ctx.fillText(fmt(n, ds, chart, i), el.x, y);
        });
      });

      ctx.restore();
    }
  };
  Chart.register(window.chartValueLabels);
}


// registra o plugin globalmente
// Chart.register(chartValueLabels);



    // espera simples
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    
    // liga o "laborat√≥rio" de gr√°ficos fora da tela e retorna um restore()
    function useOffscreenCanvas() {
      const wrap = document.getElementById('chartWrap');
      if (!wrap) return () => {};
      const prev = {
        display: wrap.style.display,
        position: wrap.style.position,
        left: wrap.style.left,
        top: wrap.style.top,
        visibility: wrap.style.visibility,
      };
      // mostra o container, mas fora da tela (nada pisca)
      wrap.style.display = 'block';
      wrap.style.position = 'absolute';
      wrap.style.left = '-10000px';
      wrap.style.top = '-10000px';
      wrap.style.visibility = 'hidden';
      return () => Object.assign(wrap.style, prev);
    }

    function normalizeMedias(m){
  if (!m) return null;
  const pick = (obj, ...keys) =>
    keys.reduce((v,k)=> v ?? obj?.[k], null);

  const toNum = v => {
    if (v == null) return null;
    const n = Number(String(v).replace(',', '.'));
    return Number.isFinite(n) ? n : null;
  };

  const out = {
    linguagens: toNum(pick(m, 'linguagens','ling','Linguagens','LING')),
    humanas:    toNum(pick(m, 'humanas','hum','Humanas','HUM')),
    natureza:   toNum(pick(m, 'natureza','nat','Natureza','NAT')),
    matematica: toNum(pick(m, 'matematica','mat','Matem√°tica','MAT'))
  };

  // se tudo deu null, considera inv√°lido
  return (out.linguagens ?? out.humanas ?? out.natureza ?? out.matematica) != null ? out : null;
}

  //justificar o texto do pdf
  function drawJustifiedLine(text, x, y, size=12, maxWidth=contentWidth()){
  const { page, font } = _pdf_ctx;
  const words = String(text||'').trim().split(/\s+/);
  if (words.length <= 1) { drawTextLine(text, x, y, size); return; }

  const spaceW = font.widthOfTextAtSize(' ', size);
  const wordsW = words.reduce((s,w)=> s + font.widthOfTextAtSize(w, size), 0);
  const gaps   = words.length - 1;
  const normal = wordsW + gaps*spaceW;

  // se j√° est√° ‚Äúcheio‚Äù, n√£o for√ßa
  if (normal >= maxWidth * 0.985) { drawTextLine(text, x, y, size); return; }

  const extraPerGap = (maxWidth - normal) / gaps;
  let cursor = x;
  for (let i=0;i<words.length;i++){
    const w = words[i];
    page.drawText(w, { x: cursor, y, size, font });
    cursor += font.widthOfTextAtSize(w, size);
    if (i < gaps) cursor += spaceW + extraPerGap;
  }
}


    // 2 casas para n√∫meros; se n√£o for n√∫mero, devolve como veio ou '-'
function fmt2(v){
  if (v == null) return '-';
  const n = Number(v);
  return Number.isFinite(n) ? n.toFixed(2) : String(v);
}

/**
 * Desenha uma tabela simples de 2 colunas (r√≥tulo / valor)
 * rows: [ [label, value], ... ]
 * Retorna o novo y (j√° descontado a altura + um pequeno espa√ßamento)
 */
function drawKeyValTable(rows, x, y, opts={}){
  const { page, font } = _pdf_ctx;
  const size   = opts.size   ?? 12;
  const rowH   = opts.rowH   ?? Math.round(size * 1.35);   // altura da linha
  const labW   = opts.labelW ?? 115;                       // largura da coluna de r√≥tulos
  const valW   = opts.valueW ?? 90;                        // largura da coluna de valores
  const padX   = opts.padX   ?? 6;
  const gap    = opts.gap    ?? 10;                        // espa√ßo abaixo da tabela
  const wTotal = labW + valW;
  const hTotal = rowH * rows.length;

  // borda da tabela
  page.drawRectangle({
    x, y: y - hTotal, width: wTotal, height: hTotal,
    borderWidth: 0.5,
    borderColor: PDFLib.rgb(0.82, 0.86, 0.94),
    color: PDFLib.rgb(1,1,1)
  });

  // linhas com ‚Äúzebra‚Äù
  rows.forEach((r, i) => {
    const rowTop = y - rowH * (i + 1);
    if (i % 2 === 0) {
      page.drawRectangle({
        x, y: rowTop, width: wTotal, height: rowH,
        color: PDFLib.rgb(0.97, 0.98, 1)
      });
    }
    const base = rowTop + Math.round((rowH - size) / 2); // ‚Äúcentraliza‚Äù verticalmente

    // r√≥tulo
    page.drawText(String(r[0] ?? ''), {
      x: x + padX, y: base, size, font, color: PDFLib.rgb(0,0,0)
    });

    // valor (alinhado √† direita)
    const valStr = String(r[1] ?? '-');
    const tw = font.widthOfTextAtSize(valStr, size);
    const vx = x + labW + valW - padX - tw;
    page.drawText(valStr, { x: vx, y: base, size, font, color: PDFLib.rgb(0,0,0) });
  });

  return y - hTotal - gap;
}

    // Tabela centralizada, transl√∫cida e com 2 casas nas √°reas
function drawScoreTableCentered(A, C, yTop) {
  const size = 12;
  const lh   = Math.round(size * 1.25);
  const pad  = 8;

  // linhas: [r√≥tulo, valor, ehNota?]  (ehNota => 2 casas decimais)
  const linhas = [
    ['Linguagens', A.linguagens, true],
    ['Humanas',    A.humanas,    true],
    ['Natureza',   A.natureza,   true],
    ['Matem√°tica', A.matematica, true],
    ['Classifica√ß√£o Geral',   (C.cls_g ?? '-'), false],
    ['Classifica√ß√£o na Unidade', (C.cls_u ?? '-'), false],
  ];

  // larguras das colunas
  const COL1 = 190;   // r√≥tulos
  const COL2 = 90;    // valores (alinhados √† direita)
  const W    = COL1 + COL2 + pad*2;
  const H    = linhas.length * lh + pad*2;

  // centraliza horizontalmente
  const x = Math.round((_pdf_ctx.page.getWidth() - W) / 2);
  const y = yTop;                 // topo da caixa
  const yBox = y - H;             // base da caixa

  // fundo transl√∫cido (mostra a marca d‚Äô√°gua)
  _pdf_ctx.page.drawRectangle({
    x, y: yBox, width: W, height: H,
    color: PDFLib.rgb(1,1,1),     // branco
    opacity: 0.55,                // transpar√™ncia
    borderColor: PDFLib.rgb(0.85,0.9,1),
    borderWidth: 1,
    borderOpacity: 0.8
  });

  // escreve linhas
  for (let i = 0; i < linhas.length; i++) {
    const yy = y - pad - (i+0.8)*lh;   // posi√ß√£o da linha (um tiquinho acima do centro do lh)
    const [rot, val, ehNota] = linhas[i];

    // r√≥tulo (esq.)
    drawTextLine(rot, x + pad, yy, size);

    // valor (dir., alinhado √† direita)
    let texto;
    if (val == null || val === '-') {
      texto = '-';
    } else if (ehNota) {
      const n = Number(val);
      texto = Number.isFinite(n) ? n.toFixed(2) : String(val);
    } else {
      texto = String(val);
    }

    const tw = _pdf_ctx.font.widthOfTextAtSize(texto, size);
    const xRight = x + pad + COL1 + COL2;          // borda direita da coluna de valores
    drawTextLine(texto, xRight - tw, yy, size);
  }

  // retorna o novo Y logo abaixo da caixa, com um espacinho
  return (yBox - 10);
}

    
    
  </script>
</body>
</html>
