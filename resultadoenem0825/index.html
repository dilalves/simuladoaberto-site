<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Resultado - Simulado Aberto ENEM Agosto</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    header {
    margin: 0;
    padding: 20px 0;
    background-color: #002776;
    color: white;
    text-align: center;
  }
    body { background:#fafafa }

    h1 { margin: 0; font-size: 24px; }
    
    footer { text-align: center; padding: 20px; font-size: 14px; color: #888; }
    
    .msg-box { padding:10px; border-left:4px solid #1976d2; background:#e3f2fd; margin:8px 0; border-radius:4px }
    #chartWrap { display:none } /* canvas oculto s√≥ para gerar a imagem do gr√°fico no PDF */
    img.redacao { max-width:100%; border:1px solid #ddd; border-radius:4px }
  </style>
</head>
<body>
  <header>
    <h1>Simulados Abertos ‚Äî Curso Objetivo Vestibulares</h1>
  </header>
  <img src="https://lh3.googleusercontent.com/5nyUCpU0Fz51OEgk2kJNCfAEJ4mbrWWsmw1-MnI0Sxr0N0QLOUcCfIhEKKc9bfjpA1Z6C5AbRZGqkO42snJrTMPFhvwDEAl5FosWt4xpmJ9xuh1NxZT7to9WbIXm3AjGiSob5nLJHYi0-I23tp7VCNzoN-w5hEABhsUG2dkTW5g-zP0mvXqiOw=w1280" class="CENy8b" role="img">
<div class="container" style="max-width:900px; margin-top:28px">
  <h5 class="blue-text text-darken-2">Consultar Resultado</h5>

  <div class="card">
    <div class="card-content">
      <div class="row">
        <div class="input-field col s12 m6">
          <input id="inscricao" type="text" required>
          <label for="inscricao">Inscri√ß√£o</label>
        </div>
        <div class="input-field col s12 m6">
          <input id="cpf" type="text" required placeholder="somente n√∫meros">
          <label for="cpf">CPF</label>
        </div>
      </div>

      <div class="row" style="margin-bottom:0">
        <div class="col s12">
          <button id="btnConsultar" class="btn waves-effect waves-light">Consultar</button>
          <button id="btnPdf" class="btn grey waves-effect waves-light" disabled>Baixar PDF</button>
          <span id="status" class="grey-text text-darken-1" style="margin-left:12px"></span>
        </div>
      </div>

      <div id="msg" style="margin-top:12px; color:#d32f2f"></div>
    </div>
  </div>

  <div id="resultado" style="display:none">
    <div class="card">
      <div class="card-content">
        <span class="card-title" id="alunoNome"></span>

        <table class="striped">
          <tbody>
            <tr><th>Inscri√ß√£o</th><td id="inscOut"></td></tr>
            <tr><th>Unidade</th><td id="unidOut"></td></tr>
            <tr><th>LINGUAGENS</th><td id="n_ling"></td></tr>
            <tr><th>HUMANAS</th><td id="n_hum"></td></tr>
            <tr><th>NATUREZA</th><td id="n_nat"></td></tr>
            <tr><th>MATEM√ÅTICA</th><td id="n_mat"></td></tr>
            <tr><th>Reda√ß√£o (Total)</th><td id="n_red_total"></td></tr>
            <tr><th>CLS_G (Class. geral)</th><td id="n_CLS_G"></td></tr>
            <tr><th>CLS_U (Class. na unidade)</th><td id="n_CLS_U"></td></tr>
            <tr><th>Compet√™ncias (C1‚ÄìC5)</th><td id="n_red_comp"></td></tr>
          </tbody>
        </table>

        <div id="mensagens" style="margin-top:10px">
          <div id="msg_ling" class="msg-box"></div>
          <div id="msg_hum"  class="msg-box"></div>
          <div id="msg_nat"  class="msg-box"></div>
          <div id="msg_mat"  class="msg-box"></div>
          <div id="msg_red"  class="msg-box"></div>
        </div>

        <div style="margin-top:16px">
          <h6 class="blue-text text-darken-2">Imagem da Reda√ß√£o</h6>
          <div id="imgBox"></div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Canvas escondido para gerar gr√°fico para o PDF -->
  <div id="chartWrap"><canvas id="grafico" width="900" height="420"></canvas></div>
</div>

<footer>simuladoaberto.com - Curso Objetivo Vestibulares</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

<script>
/* ===== CONFIGURE AQUI ===== */
const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwradbKRivZtlC3TAWqqPuIsC1UoM6Lgh53FRsM0Z9GryRZ6EcPAXP6NVj_3KqNwJw3/exec'; // action=resultado

/* ===== ESTADO ===== */
let ultimoResultado = null;

/* ===== EVENTOS ===== */
document.getElementById('btnConsultar').addEventListener('click', consultar);
document.getElementById('btnPdf').addEventListener('click', gerarPDF);

/* ===== CONSULTA ===== */
async function consultar(){
  const status = document.getElementById('status');
  const msg = document.getElementById('msg');
  const resDiv = document.getElementById('resultado');
  const btnPdf = document.getElementById('btnPdf');

  status.textContent = 'Consultando...';
  msg.textContent = '';
  resDiv.style.display = 'none';
  btnPdf.disabled = true; btnPdf.classList.add('grey');

  const insc = document.getElementById('inscricao').value.replace(/\D/g,'');
  const cpf  = document.getElementById('cpf').value.replace(/\D/g,'');
  if (!insc || cpf.length < 11) { msg.textContent = 'Preencha inscri√ß√£o e CPF v√°lidos.'; status.textContent=''; return; }

  try{
    const url = `${ENDPOINT}?action=resultado&inscricao=${encodeURIComponent(insc)}&cpf=${encodeURIComponent(cpf)}`;
    const r = await fetch(url, { cache:'no-store' });
    const j = await r.json();
    if (!j.ok) { msg.textContent = j.error || 'N√£o encontrado'; status.textContent=''; return; }

    ultimoResultado = j;

    // Cabe√ßalho e tabela
    document.getElementById('alunoNome').textContent = (j.aluno && j.aluno.nome) ? j.aluno.nome : `Inscri√ß√£o ${j.inscricao}`;
    document.getElementById('inscOut').textContent = j.inscricao;
    // üëâ mostrar NOME da unidade (n√£o o c√≥digo)
    document.getElementById('unidOut').textContent = (j.aluno && j.aluno.unidadeNome) ? j.aluno.unidadeNome : '-';

    const A = j.areas || {};
    const R = j.redacao || {};
    const C = j.classificacao || {};
    setText('n_ling', A.linguagens);
    setText('n_hum',  A.humanas);
    setText('n_nat',  A.natureza);
    setText('n_mat',  A.matematica);
    setText('n_red_total', R.total);

    // CLS_G / CLS_U
    setText('n_CLS_G', C.cls_g ?? j.cls_g ?? '-');
    setText('n_CLS_U', C.cls_u ?? j.cls_u ?? '-');

    const comps = [R.c1,R.c2,R.c3,R.c4,R.c5].filter(x=>x!=null).join(' / ') || '-';
    document.getElementById('n_red_comp').textContent = comps;

    // Mensagens personalizadas
    const msgs = getMessages(A, R);
    document.getElementById('msg_ling').textContent = msgs.linguagens;
    document.getElementById('msg_hum').textContent  = msgs.humanas;
    document.getElementById('msg_nat').textContent  = msgs.natureza;
    document.getElementById('msg_mat').textContent  = msgs.matematica;
    document.getElementById('msg_red').textContent  = msgs.redacao;

    // Imagem/preview da Reda√ß√£o (com fallback)
    const L = j.links || {};
    montarRedacao(L.imagemRedacao);

    resDiv.style.display = 'block';
    btnPdf.disabled = false; btnPdf.classList.remove('grey');
    status.textContent = '';
  }catch(e){
    msg.textContent = 'Erro ao consultar. Tente novamente.';
    console.error(e);
    status.textContent='';
  }
}

function setText(id, v){ document.getElementById(id).textContent = (v==null?'-':v); }

/* ===== Drive helpers + fallback imagem/preview ===== */
function driveIdFrom(link){
  if (!link) return null;
  const m1 = String(link).match(/\/file\/d\/([^/]+)\//); // /file/d/ID/
  if (m1) return m1[1];
  const m2 = String(link).match(/[?&]id=([^&]+)/);       // ?id=ID
  return m2 ? m2[1] : null;
}

function montarRedacao(link) {
  const box = document.getElementById('imgBox');
  if (!box) return;
  box.innerHTML = '';
  if (!link) return;

  // Constr√≥i varia√ß√µes de link a partir do ID (se existir)
  const idMatch1 = String(link).match(/\/file\/d\/([^/]+)\//);
  const idMatch2 = String(link).match(/[?&]id=([^&]+)/);
  const id = idMatch1 ? idMatch1[1] : (idMatch2 ? idMatch2[1] : null);

  const direct  = id ? `https://drive.google.com/uc?id=${id}&export=view`        : link; // imagem direta
  const preview = id ? `https://drive.google.com/file/d/${id}/preview`           : link; // preview em iframe
  const view    = id ? `https://drive.google.com/file/d/${id}/view`              : link; // link "Abrir no Drive"

  // 1) Tenta como imagem
  const img = new Image();
  img.className = 'redacao';
  img.alt = 'Reda√ß√£o';
  img.src = direct;

  // Se a imagem falhar (ex.: arquivo √© PDF), troca para iframe preview
  img.onerror = () => {
    box.innerHTML = '';
    const ifr = document.createElement('iframe');
    ifr.style.width = '100%';
    ifr.style.height = '820px';
    ifr.style.border = '0';
    ifr.src = preview;
    box.appendChild(ifr);

    // link alternativo
    const p = document.createElement('p');
    p.style.marginTop = '8px';
    const a = document.createElement('a');
    a.href = view; a.target = '_blank'; a.rel = 'noopener';
    a.textContent = 'Abrir no Google Drive';
    p.append('N√£o carregou como imagem? ', a);
    box.appendChild(p);
  };

  // Se carregar como imagem, tamb√©m mostra o link alternativo
  img.onload = () => {
    box.appendChild(img);
    const p = document.createElement('p');
    p.style.marginTop = '8px';
    const a = document.createElement('a');
    a.href = view; a.target = '_blank'; a.rel = 'noopener';
    a.textContent = 'Abrir no Google Drive';
    p.append('N√£o carregou como imagem? ', a);
    box.appendChild(p);
  };

  // adiciona imediatamente (se der erro, o onerror troca)
  box.appendChild(img);
}



/* ===== MENSAGENS POR NOTA ===== */
/* ===== MENSAGENS POR NOTA (faixas por √°rea) ===== */
function getMessages(A, R){
  const L = A?.linguagens ?? null;
  const H = A?.humanas    ?? null;
  const N = A?.natureza   ?? null;
  const M = A?.matematica ?? null;
  const RT= R?.total      ?? null;

  return {
    linguagens: msgLinguagens(L),
    humanas:    msgHumanas(H),
    natureza:   msgNatureza(N),
    matematica: msgMatematica(M),
    redacao:    msgRedacao(RT)
  };
}

/* --- helpers gen√©ricos --- */
function faixa(nota, faixas, msgSemNota){
  if (nota == null) return msgSemNota;
  for (const f of faixas){
    const okMin = nota >= f.min;
    const okMax = f.max == null ? true : nota <= f.max;
    if (okMin && okMax) return f.msg;
  }
  return faixas.at(-1).msg; // fallback
}

/* --- mensagens por √°rea --- */
function msgLinguagens(nota){
  return faixa(nota, [
    {min:-Infinity, max:400, msg:"Linguagens: Voc√™ j√° deu o primeiro passo! Que tal ler mais textos variados, como not√≠cias, charges e cr√¥nicas? A pr√°tica da leitura vai ajudar a interpretar melhor e evoluir nos estudos."},
    {min:400, max:499, msg:"Linguagens: Seu caminho j√° come√ßou! Foque em entender as ideias principais dos textos, sublinhando palavras-chave. Quanto mais contato com a leitura, melhor o desempenho!"},
    {min:500, max:599, msg:"Linguagens: √ìtimo trabalho! Voc√™ est√° no caminho certo. Continue lendo diferentes g√™neros e praticando a interpreta√ß√£o. Discutir ideias tamb√©m aprimora a compreens√£o."},
    {min:600, max:649, msg:"Linguagens: Seu desempenho est√° crescendo! Experimente leituras mais desafiadoras (poesia, artigo de opini√£o). Resolver provas anteriores melhora a compreens√£o de textos."},
    {min:650, max:699, msg:"Linguagens: Incr√≠vel! Seu dom√≠nio de leitura est√° avan√ßado. Explorar obras liter√°rias amplia vocabul√°rio e diferentes pontos de vista."},
    {min:700, max:799, msg:"Linguagens: Parab√©ns! Boa compreens√£o e capacidade cr√≠tica. Continue com leituras complexas e argumentos bem estruturados."},
    {min:800, max:null, msg:"Linguagens: Excepcional! Dom√≠nio alto de linguagem e interpreta√ß√£o. Explore literatura e textos acad√™micos para lapidar a an√°lise cr√≠tica."}
  ], "Linguagens: sem nota registrada.");
}

function msgHumanas(nota){
  return faixa(nota, [
    {min:-Infinity, max:400, msg:"Humanas: Voc√™ j√° come√ßou a construir seu conhecimento em Ci√™ncias Humanas! Que tal explorar mais sobre hist√≥ria, geografia, sociologia e filosofia? Assistir a document√°rios e ler textos variados pode ajudar a entender melhor os temas."},
    {min:400, max:499, msg:"Humanas: √ìtimo come√ßo! Foque em compreender os principais acontecimentos hist√≥ricos e suas conex√µes com o presente. Reflita sobre temas sociais e pol√≠ticos para ampliar sua vis√£o de mundo."},
    {min:500, max:599, msg:"Humanas: Bom trabalho! Seu conhecimento em Ci√™ncias Humanas est√° se fortalecendo. Continue lendo livros e artigos sobre temas hist√≥ricos e sociais. Debater ideias e formar opini√µes embasadas pode ajudar a consolidar seu aprendizado."},
    {min:600, max:649, msg:"Humanas: Muito bem! Voc√™ j√° tem uma boa compreens√£o dos conte√∫dos. Continue relacionando os temas estudados com quest√µes do mundo atual e explore fontes confi√°veis para aprofundar ainda mais seu conhecimento."},
    {min:650, max:699, msg:"Humanas: Parab√©ns! Seu desempenho em Ci√™ncias Humanas mostra que voc√™ domina os temas com profundidade. Continue explorando autores cl√°ssicos e contempor√¢neos para enriquecer ainda mais suas an√°lises."},
    {min:700, max:799, msg:"Humanas: Excelente! Seu racioc√≠nio cr√≠tico e interpreta√ß√£o dos fatos hist√≥ricos e sociais s√£o impressionantes. Continue desenvolvendo sua capacidade anal√≠tica e aprofundando seus conhecimentos sobre geopol√≠tica, economia e filosofia."},
    {min:800, max:null, msg:"Humanas: Fant√°stico! Seu conhecimento em Ci√™ncias Humanas est√° em alto n√≠vel. Sua capacidade de an√°lise cr√≠tica e reflex√£o sobre o mundo √© admir√°vel. Continue explorando diferentes perspectivas e conectando os temas para expandir ainda mais sua vis√£o global."}
  ], "Humanas: sem nota registrada.");
}

function msgNatureza(nota){
  return faixa(nota, [
    {min:-Infinity, max:400, msg:"Natureza: Voc√™ deu o primeiro passo! Explore mais os fen√¥menos naturais e suas aplica√ß√µes. Estudar de forma pr√°tica, fazendo experimentos simples, por exemplo, pode ajudar a entender melhor os conceitos."},
    {min:400, max:499, msg:"Natureza: Voc√™ est√° come√ßando a construir seu conhecimento! Continue focando nas bases e pratique resolvendo quest√µes e experimentos simples. Isso ajudar√° a evoluir ainda mais."},
    {min:500, max:599, msg:"Natureza: Bom progresso! Seu conhecimento em Ci√™ncias da Natureza est√° crescendo. Continue praticando e conectando conceitos ao cotidiano. Resolver quest√µes de provas anteriores e analisar experimentos simples vai ajudar muito!"},
    {min:600, max:649, msg:"Natureza: √ìtimo trabalho! Seu desempenho est√° se destacando. Aprofunde-se mais em t√≥picos desafiadores, leia livros complementares e resolva quest√µes avan√ßadas para impulsionar ainda mais seu aprendizado."},
    {min:650, max:699, msg:"Natureza: Excelente! Seu dom√≠nio dos conceitos est√° √≥timo. Explore mais as aplica√ß√µes pr√°ticas da ci√™ncia, leia materiais complementares e analise experimentos desafiadores para expandir ainda mais seu conhecimento."},
    {min:700, max:799, msg:"Natureza: Parab√©ns! Voc√™ est√° indo muito bem. Aprofunde ainda mais seus estudos, investigue fen√¥menos naturais complexos e resolva quest√µes de n√≠vel avan√ßado. Seu desempenho reflete uma grande capacidade de an√°lise!"},
    {min:800, max:null, msg:"Natureza: Incr√≠vel! Seu conhecimento √© de alto n√≠vel. Sua capacidade de racioc√≠nio cient√≠fico √© excelente. Continue explorando t√≥picos avan√ßados, analisando experimentos complexos e desafiando-se a ir al√©m nos estudos."}
  ], "Natureza: sem nota registrada.");
}

function msgMatematica(nota){
  return faixa(nota, [
    {min:-Infinity, max:400, msg:"Matem√°tica: Voc√™ j√° deu o primeiro passo! Que tal revisar as opera√ß√µes b√°sicas e resolver problemas mais simples? Com mais pr√°tica, voc√™ vai entender melhor os conceitos fundamentais e avan√ßar nos estudos."},
    {min:400, max:499, msg:"Matem√°tica: Voc√™ est√° no caminho certo! Foque nas bases da matem√°tica e procure resolver exerc√≠cios de problemas simples. Revisar f√≥rmulas tamb√©m vai ajudar a melhorar!"},
    {min:500, max:599, msg:"Matem√°tica: Bom trabalho! Seu entendimento de Matem√°tica est√° crescendo. Continue praticando as opera√ß√µes e explore problemas mais complexos. Resolver quest√µes de provas anteriores vai ajudar a consolidar os conceitos."},
    {min:600, max:649, msg:"Matem√°tica: Excelente progresso! Seu desempenho est√° bom, mas pode melhorar ainda mais. Aprofunde-se em √°lgebra e geometria, e resolva quest√µes de n√≠veis mais desafiadores para aprimorar seu racioc√≠nio l√≥gico."},
    {min:650, max:699, msg:"Matem√°tica: √ìtimo desempenho! Voc√™ j√° tem um bom dom√≠nio das habilidades matem√°ticas. Continue praticando √°lgebra e geometria. Tente resolver quest√µes mais dif√≠ceis e desafie-se a estudar novas √°reas da matem√°tica."},
    {min:700, max:799, msg:"Matem√°tica: Parab√©ns! Seu dom√≠nio de Matem√°tica est√° excelente. Continue aprimorando sua habilidade de resolu√ß√£o de problemas, praticando mais exerc√≠cios complexos e explorando t√≥picos mais avan√ßados, como trigonometria e fun√ß√µes."},
    {min:800, max:null, msg:"Matem√°tica: Incr√≠vel! Seu conhecimento de Matem√°tica √© impressionante. Sua capacidade de resolver problemas complexos √© excelente. Continue explorando t√≥picos avan√ßados do ensino m√©dio, como trigonometria, matrizes, probabilidade e estat√≠stica. Resolver desafios e provas mais exigentes vai ajudar voc√™ a se destacar ainda mais!"}
  ], "Matem√°tica: sem nota registrada.");
}

function msgRedacao(nota){
  return faixa(nota, [
    {min:-Infinity, max:200, msg:"Reda√ß√£o: N√£o desista! Toda jornada come√ßa com o primeiro passo. Pratique a escrita de textos dissertativos e analise reda√ß√µes nota 1000 para entender melhor a estrutura!"},
    {min:200, max:299, msg:"Reda√ß√£o: Voc√™ est√° progredindo! Foque na estrutura do texto e na sua linha de racioc√≠nio. Ler e escrever com frequ√™ncia vai ajudar a melhorar!"},
    {min:300, max:399, msg:"Reda√ß√£o: Bom come√ßo! Tente desenvolver melhor seus argumentos e ampliar seu repert√≥rio cultural. Leia editoriais, not√≠cias e artigos de opini√£o para fortalecer suas ideias."},
    {min:400, max:499, msg:"Reda√ß√£o: Seu texto tem potencial! Aprofundar sua argumenta√ß√£o e apresentar uma boa proposta de interven√ß√£o, vi√°vel e coerente com os argumentos apresentados, ajudar√° a elevar sua nota."},
    {min:500, max:599, msg:"Reda√ß√£o: Bom trabalho! Voc√™ j√° compreende bem a estrutura da reda√ß√£o. Agora, foque na progress√£o textual e no aprimoramento da proposta de interven√ß√£o, que deve conter: agente, a√ß√£o, modo/meio, efeito/finalidade e detalhamento."},
    {min:600, max:699, msg:"Reda√ß√£o: Muito bem! Sua reda√ß√£o est√° bem desenvolvida. Continue refinando a argumenta√ß√£o e explorando refer√™ncias para tornar seu texto ainda mais aprimorado, apresentando uma proposta de interven√ß√£o vi√°vel e coerente com os argumentos apresentados."},
    {min:700, max:799, msg:"Reda√ß√£o: Parab√©ns! Sua escrita √© clara e bem organizada. Para alcan√ßar um n√≠vel ainda mais alto, busque aprofundar a an√°lise cr√≠tica e verifique se sua proposta de interven√ß√£o apresenta os seguintes elementos: agente, a√ß√£o, modo/meio, efeito/finalidade, detalhamento."},
    {min:800, max:899, msg:"Reda√ß√£o: Excelente! Sua argumenta√ß√£o e dom√≠nio da escrita s√£o de alto n√≠vel. Continue praticando para alcan√ßar a nota m√°xima!"},
    {min:900, max:null, msg:"Reda√ß√£o: Fant√°stico! Sua reda√ß√£o demonstra dom√≠nio total da estrutura, argumenta√ß√£o e coes√£o. Seu n√≠vel de escrita √© digno de nota m√°xima. Continue se aprimorando e inspirando outros com seu talento!"}
  ], "Reda√ß√£o: sem nota registrada.");
}


/* ===== PDF (pdf-lib) com gr√°fico (Chart.js) ===== */
async function gerarPDF(){
  if (!ultimoResultado) return;
  const { PDFDocument, rgb, StandardFonts } = PDFLib;
  const doc = await PDFDocument.create();
  const page = doc.addPage([595.28, 841.89]); // A4 portrait em pt (72dpi)
  const font = await doc.embedFont(StandardFonts.Helvetica);
  const draw = (p, txt, x, y, size=12)=> p.drawText(txt, { x, y, size, font, color: rgb(0,0,0) });

  const j = ultimoResultado;
  let y = 800;
  draw(page, 'Resultado ENEM', 40, y, 18); y-=24;
  draw(page, `Aluno: ${ (j.aluno&&j.aluno.nome) || '-' }`, 40, y); y-=16;
  // üëâ usa NOME da unidade
  draw(page, `Inscri√ß√£o: ${j.inscricao}   Unidade: ${(j.aluno&&j.aluno.unidadeNome)||'-'}`, 40, y); y-=20;

  const A = j.areas || {}, R = j.redacao || {};
  const C = j.classificacao || {};
  
  const linhas = [
    ['Linguagens', val(A.linguagens)], ['Humanas', val(A.humanas)],
    ['Natureza', val(A.natureza)], ['Matem√°tica', val(A.matematica)],
    ['Reda√ß√£o (total)', val(R.total)],
    ['CLS_G', val(C.cls_g ?? j.cls_g)],
    ['CLS_U', val(C.cls_u ?? j.cls_u)]
  ];
  linhas.forEach(([k,v])=>{ draw(page, `${k}: ${v}`, 40, y); y-=14; });

  // Gr√°fico
  const chartUrl = await makeChartImage(A, R);
  if (chartUrl){
    const chartBytes = dataURLtoBytes(chartUrl);
    const chartImg = await doc.embedPng(chartBytes);
    const w = 500, h = 230;
    page.drawImage(chartImg, { x: 40, y: y - h - 10, width: w, height: h });
    y -= (h + 20);
  }

  // Mensagens
  const msgs = getMessages(A, R);
  [msgs.linguagens, msgs.humanas, msgs.natureza, msgs.matematica, msgs.redacao]
    .forEach(m=>{ y -= 14; draw(page, '‚Ä¢ ' + m, 40, y); });

  const bytes = await doc.save();
  const blob = new Blob([bytes], { type:'application/pdf' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `resultado_ENEM_${j.inscricao}.pdf`;
  a.click();
}

/* ===== helpers ===== */
function val(x){ return (x==null?'-':x); }
function dataURLtoBytes(dataURL){
  const base64 = dataURL.split(',')[1];
  const bin = atob(base64); const len = bin.length;
  const bytes = new Uint8Array(len);
  for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
  return bytes;
}
async function makeChartImage(A, R){
  const el = document.getElementById('grafico');
  if (!el) return null;
  if (window._chartInst) { window._chartInst.destroy(); }

  const labels = ['LING', 'HUM', 'NAT', 'MAT', 'RED'];
  const data = [A.linguagens ?? null, A.humanas ?? null, A.natureza ?? null, A.matematica ?? null, R.total ?? null];

  window._chartInst = new Chart(el.getContext('2d'), {
    type: 'bar',
    data: { labels, datasets: [{ label:'Notas', data }] },
    options: { responsive: false, animation: false, scales: { y: { suggestedMin: 0, suggestedMax: 1000 } } }
  });

  await new Promise(r=>setTimeout(r, 50));
  return el.toDataURL('image/png');
}
</script>
</body>
</html>
