<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Resultado - Simulado Aberto ENEM Agosto</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

  <style>
    header { margin:0; padding:20px 0; background:#002776; color:#fff; text-align:center }
    body { background:#fafafa }
    h1 { margin:0; font-size:24px }
    footer { text-align:center; padding:20px; font-size:14px; color:#888 }
    .msg-box { padding:10px; border-left:4px solid #1976d2; background:#e3f2fd; margin:8px 0; border-radius:4px }
    #chartWrap { display:none } /* canvas oculto só para gerar imagem do gráfico no PDF */
    img.redacao { max-width:100%; border:1px solid #ddd; border-radius:4px }
  </style>
</head>
<body>
  <header>
    <h1>Simulados Abertos — Curso Objetivo Vestibulares</h1>
  </header>

  <div class="container" style="max-width:900px; margin-top:28px">
    <h5 class="blue-text text-darken-2">Consultar Resultado</h5>

    <div class="card">
      <div class="card-content">
        <div class="row">
          <div class="input-field col s12 m6">
            <input id="inscricao" type="text" required>
            <label for="inscricao">Inscrição</label>
          </div>
          <div class="input-field col s12 m6">
            <input id="cpf" type="text" required placeholder="somente números">
            <label for="cpf">CPF</label>
          </div>
        </div>

        <div class="row" style="margin-bottom:0">
          <div class="col s12">
            <button id="btnConsultar" class="btn waves-effect waves-light">Consultar</button>
            <button id="btnPdf" class="btn grey waves-effect waves-light" disabled>Baixar PDF</button>
            <span id="status" class="grey-text text-darken-1" style="margin-left:12px"></span>
          </div>
        </div>

        <div id="msg" style="margin-top:12px; color:#d32f2f"></div>
      </div>
    </div>

    <div id="resultado" style="display:none">
      <div class="card">
        <div class="card-content">
          <span class="card-title" id="alunoNome"></span>

          <table class="striped">
            <tbody>
              <tr><th>Inscrição</th><td id="inscOut"></td></tr>
              <tr><th>Unidade</th><td id="unidOut"></td></tr>
              <tr><th>LINGUAGENS</th><td id="n_ling"></td></tr>
              <tr><th>HUMANAS</th><td id="n_hum"></td></tr>
              <tr><th>NATUREZA</th><td id="n_nat"></td></tr>
              <tr><th>MATEMÁTICA</th><td id="n_mat"></td></tr>
              <tr><th>Redação (Total)</th><td id="n_red_total"></td></tr>
              <tr><th>CLS_G (Class. geral)</th><td id="n_CLS_G"></td></tr>
              <tr><th>CLS_U (Class. na unidade)</th><td id="n_CLS_U"></td></tr>
              <tr><th>Competências (C1–C5)</th><td id="n_red_comp"></td></tr>
            </tbody>
          </table>

          <div id="mensagens" style="margin-top:10px">
            <div id="msg_ling" class="msg-box"></div>
            <div id="msg_hum"  class="msg-box"></div>
            <div id="msg_nat"  class="msg-box"></div>
            <div id="msg_mat"  class="msg-box"></div>
            <div id="msg_red"  class="msg-box"></div>
          </div>

          <div style="margin-top:16px">
            <h6 class="blue-text text-darken-2">Imagem da Redação</h6>
            <div id="imgBox"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Canvas escondido para gerar gráfico para o PDF -->
    <div id="chartWrap"><canvas id="grafico" width="900" height="420"></canvas></div>
  </div>

  <footer>simuladoaberto.com - Curso Objetivo Vestibulares</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <script>
  /* ===== CONFIG ===== */
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwradbKRivZtlC3TAWqqPuIsC1UoM6Lgh53FRsM0Z9GryRZ6EcPAXP6NVj_3KqNwJw3/exec';

  /* ===== ESTADO ===== */
  let ultimoResultado = null;

  /* ===== EVENTOS ===== */
  document.getElementById('btnConsultar').addEventListener('click', consultar);
  document.getElementById('btnPdf').addEventListener('click', gerarPDF);

  /* ===== CONSULTA ===== */
  async function consultar(){
    const status = document.getElementById('status');
    const msg = document.getElementById('msg');
    const resDiv = document.getElementById('resultado');
    const btnPdf = document.getElementById('btnPdf');

    status.textContent = 'Consultando...';
    msg.textContent = '';
    resDiv.style.display = 'none';
    btnPdf.disabled = true; btnPdf.classList.add('grey');

    const insc = document.getElementById('inscricao').value.replace(/\D/g,'');
    const cpf  = document.getElementById('cpf').value.replace(/\D/g,'');
    if (!insc || cpf.length < 11) { msg.textContent = 'Preencha inscrição e CPF válidos.'; status.textContent=''; return; }

    try{
      const url = `${ENDPOINT}?action=resultado&inscricao=${encodeURIComponent(insc)}&cpf=${encodeURIComponent(cpf)}`;
      const r = await fetch(url, { cache:'no-store' });
      const j = await r.json();
      if (!j.ok) { msg.textContent = j.error || 'Não encontrado'; status.textContent=''; return; }

      ultimoResultado = j;

      // Cabeçalho e tabela
      document.getElementById('alunoNome').textContent = (j.aluno && j.aluno.nome) ? j.aluno.nome : `Inscrição ${j.inscricao}`;
      document.getElementById('inscOut').textContent = j.inscricao;
      document.getElementById('unidOut').textContent = (j.aluno && j.aluno.unidadeNome) ? j.aluno.unidadeNome : '-';

      const A = j.areas || {};
      const R = j.redacao || {};
      const C = j.classificacao || {};
      setText('n_ling', A.linguagens);
      setText('n_hum',  A.humanas);
      setText('n_nat',  A.natureza);
      setText('n_mat',  A.matematica);
      setText('n_red_total', R.total);

      setText('n_CLS_G', C.cls_g ?? j.cls_g ?? '-');
      setText('n_CLS_U', C.cls_u ?? j.cls_u ?? '-');

      const comps = [R.c1,R.c2,R.c3,R.c4,R.c5].filter(x=>x!=null).join(' / ') || '-';
      document.getElementById('n_red_comp').textContent = comps;

      // Mensagens personalizadas
      const msgs = getMessages(A, R);
      document.getElementById('msg_ling').textContent = msgs.linguagens;
      document.getElementById('msg_hum').textContent  = msgs.humanas;
      document.getElementById('msg_nat').textContent  = msgs.natureza;
      document.getElementById('msg_mat').textContent  = msgs.matematica;
      document.getElementById('msg_red').textContent  = msgs.redacao;

      // Redação (imagem -> fallback para iframe)
      const L = j.links || {};
      montarRedacao(L.imagemRedacao);

      resDiv.style.display = 'block';
      btnPdf.disabled = false; btnPdf.classList.remove('grey');
      status.textContent = '';
    }catch(e){
      msg.textContent = 'Erro ao consultar. Tente novamente.';
      console.error(e);
      status.textContent='';
    }
  }

  function setText(id, v){ document.getElementById(id).textContent = (v==null?'-':v); }

  /* ===== Redação: imagem/iframe + link ===== */
  function montarRedacao(link) {
    const box = document.getElementById('imgBox');
    if (!box) return;
    box.innerHTML = '';
    if (!link) return;

    const idMatch1 = String(link).match(/\/file\/d\/([^/]+)\//);
    const idMatch2 = String(link).match(/[?&]id=([^&]+)/);
    const id = idMatch1 ? idMatch1[1] : (idMatch2 ? idMatch2[1] : null);

    const direct  = id ? `https://drive.google.com/uc?id=${id}&export=view`  : link;   // imagem direta
    const preview = id ? `https://drive.google.com/file/d/${id}/preview`     : link;   // iframe preview
    const view    = id ? `https://drive.google.com/file/d/${id}/view`        : link;   // link "abrir"

    // tenta carregar como <img>
    const img = new Image();
    img.className = 'redacao';
    img.alt = 'Redação';
    img.src = direct;

    img.onerror = () => {
      box.innerHTML = '';
      const ifr = document.createElement('iframe');
      ifr.style.width = '100%';
      ifr.style.height = '820px';
      ifr.style.border = '0';
      ifr.src = preview;
      box.appendChild(ifr);

      const p = document.createElement('p'); p.style.marginTop = '8px';
      const a = document.createElement('a'); a.href = view; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'Abrir no Google Drive';
      p.append('Não carregou como imagem? ', a);
      box.appendChild(p);
    };

    img.onload = () => {
      box.appendChild(img);
      const p = document.createElement('p'); p.style.marginTop = '8px';
      const a = document.createElement('a'); a.href = view; a.target = '_blank'; a.rel = 'noopener'; a.textContent = 'Abrir no Google Drive';
      p.append('Não carregou como imagem? ', a);
      box.appendChild(p);
    };

    // adiciona já; se falhar, onerror troca para iframe
    box.appendChild(img);
  }

  /* ===== MENSAGENS POR NOTA (faixas por área) ===== */
  function getMessages(A, R){
    const L = A?.linguagens ?? null;
    const H = A?.humanas    ?? null;
    const N = A?.natureza   ?? null;
    const M = A?.matematica ?? null;
    const RT= R?.total      ?? null;

    return {
      linguagens: msgLinguagens(L),
      humanas:    msgHumanas(H),
      natureza:   msgNatureza(N),
      matematica: msgMatematica(M),
      redacao:    msgRedacao(RT)
    };
  }

  function faixa(nota, faixas, msgSemNota){
    if (nota == null) return msgSemNota;
    for (const f of faixas){
      const okMin = nota >= f.min;
      const okMax = f.max == null ? true : nota <= f.max;
      if (okMin && okMax) return f.msg;
    }
    return faixas.at(-1).msg;
  }

  function msgLinguagens(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Linguagens: Você já deu o primeiro passo! Que tal ler mais textos variados, como notícias, charges e crônicas? A prática da leitura vai ajudar a interpretar melhor e evoluir nos estudos."},
      {min:400, max:499, msg:"Linguagens: Seu caminho já começou! Foque em entender as ideias principais dos textos, sublinhando palavras-chave. Quanto mais contato com a leitura, melhor o desempenho!"},
      {min:500, max:599, msg:"Linguagens: Ótimo trabalho! Você está no caminho certo. Continue lendo diferentes gêneros e praticando a interpretação. Discutir ideias também aprimora a compreensão."},
      {min:600, max:649, msg:"Linguagens: Seu desempenho está crescendo! Experimente leituras mais desafiadoras (poesia, artigo de opinião). Resolver provas anteriores melhora a compreensão de textos."},
      {min:650, max:699, msg:"Linguagens: Incrível! Seu domínio de leitura está avançado. Explorar obras literárias amplia vocabulário e diferentes pontos de vista."},
      {min:700, max:799, msg:"Linguagens: Parabéns! Boa compreensão e capacidade crítica. Continue com leituras complexas e argumentos bem estruturados."},
      {min:800, max:null, msg:"Linguagens: Excepcional! Domínio alto de linguagem e interpretação. Explore literatura e textos acadêmicos para lapidar a análise crítica."}
    ], "Linguagens: sem nota registrada.");
  }

  function msgHumanas(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Humanas: Você já começou a construir seu conhecimento em Ciências Humanas! Que tal explorar mais sobre história, geografia, sociologia e filosofia? Assistir a documentários e ler textos variados pode ajudar a entender melhor os temas."},
      {min:400, max:499, msg:"Humanas: Ótimo começo! Foque em compreender os principais acontecimentos históricos e suas conexões com o presente. Reflita sobre temas sociais e políticos para ampliar sua visão de mundo."},
      {min:500, max:599, msg:"Humanas: Bom trabalho! Seu conhecimento em Ciências Humanas está se fortalecendo. Continue lendo livros e artigos sobre temas históricos e sociais. Debater ideias e formar opiniões embasadas pode ajudar a consolidar seu aprendizado."},
      {min:600, max:649, msg:"Humanas: Muito bem! Você já tem uma boa compreensão dos conteúdos. Continue relacionando os temas estudados com questões do mundo atual e explore fontes confiáveis para aprofundar ainda mais seu conhecimento."},
      {min:650, max:699, msg:"Humanas: Parabéns! Seu desempenho em Ciências Humanas mostra que você domina os temas com profundidade. Continue explorando autores clássicos e contemporâneos para enriquecer ainda mais suas análises."},
      {min:700, max:799, msg:"Humanas: Excelente! Seu raciocínio crítico e interpretação dos fatos históricos e sociais são impressionantes. Continue desenvolvendo sua capacidade analítica e aprofundando seus conhecimentos sobre geopolítica, economia e filosofia."},
      {min:800, max:null, msg:"Humanas: Fantástico! Seu conhecimento em Ciências Humanas está em alto nível. Sua capacidade de análise crítica e reflexão sobre o mundo é admirável. Continue explorando diferentes perspectivas e conectando os temas para expandir ainda mais sua visão global."}
    ], "Humanas: sem nota registrada.");
  }

  function msgNatureza(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Natureza: Você deu o primeiro passo! Explore mais os fenômenos naturais e suas aplicações. Estudar de forma prática, fazendo experimentos simples, por exemplo, pode ajudar a entender melhor os conceitos."},
      {min:400, max:499, msg:"Natureza: Você está começando a construir seu conhecimento! Continue focando nas bases e pratique resolvendo questões e experimentos simples. Isso ajudará a evoluir ainda mais."},
      {min:500, max:599, msg:"Natureza: Bom progresso! Seu conhecimento em Ciências da Natureza está crescendo. Continue praticando e conectando conceitos ao cotidiano. Resolver questões de provas anteriores e analisar experimentos simples vai ajudar muito!"},
      {min:600, max:649, msg:"Natureza: Ótimo trabalho! Seu desempenho está se destacando. Aprofunde-se mais em tópicos desafiadores, leia livros complementares e resolva questões avançadas para impulsionar ainda mais seu aprendizado."},
      {min:650, max:699, msg:"Natureza: Excelente! Seu domínio dos conceitos está ótimo. Explore mais as aplicações práticas da ciência, leia materiais complementares e analise experimentos desafiadores para expandir ainda mais seu conhecimento."},
      {min:700, max:799, msg:"Natureza: Parabéns! Você está indo muito bem. Aprofunde ainda mais seus estudos, investigue fenômenos naturais complexos e resolva questões de nível avançado. Seu desempenho reflete uma grande capacidade de análise!"},
      {min:800, max:null, msg:"Natureza: Incrível! Seu conhecimento é de alto nível. Sua capacidade de raciocínio científico é excelente. Continue explorando tópicos avançados, analisando experimentos complexos e desafiando-se a ir além nos estudos."}
    ], "Natureza: sem nota registrada.");
  }

  function msgMatematica(nota){
    return faixa(nota, [
      {min:-Infinity, max:400, msg:"Matemática: Você já deu o primeiro passo! Que tal revisar as operações básicas e resolver problemas mais simples? Com mais prática, você vai entender melhor os conceitos fundamentais e avançar nos estudos."},
      {min:400, max:499, msg:"Matemática: Você está no caminho certo! Foque nas bases da matemática e procure resolver exercícios de problemas simples. Revisar fórmulas também vai ajudar a melhorar!"},
      {min:500, max:599, msg:"Matemática: Bom trabalho! Seu entendimento de Matemática está crescendo. Continue praticando as operações e explore problemas mais complexos. Resolver questões de provas anteriores vai ajudar a consolidar os conceitos."},
      {min:600, max:649, msg:"Matemática: Excelente progresso! Seu desempenho está bom, mas pode melhorar ainda mais. Aprofunde-se em álgebra e geometria, e resolva questões de níveis mais desafiadores para aprimorar seu raciocínio lógico."},
      {min:650, max:699, msg:"Matemática: Ótimo desempenho! Você já tem um bom domínio das habilidades matemáticas. Continue praticando álgebra e geometria. Tente resolver questões mais difíceis e desafie-se a estudar novas áreas da matemática."},
      {min:700, max:799, msg:"Matemática: Parabéns! Seu domínio de Matemática está excelente. Continue aprimorando sua habilidade de resolução de problemas, praticando mais exercícios complexos e explorando tópicos mais avançados, como trigonometria e funções."},
      {min:800, max:null, msg:"Matemática: Incrível! Seu conhecimento de Matemática é impressionante. Sua capacidade de resolver problemas complexos é excelente. Continue explorando tópicos avançados do ensino médio, como trigonometria, matrizes, probabilidade e estatística. Resolver desafios e provas mais exigentes vai ajudar você a se destacar ainda mais!"}
    ], "Matemática: sem nota registrada.");
  }

  function msgRedacao(nota){
    return faixa(nota, [
      {min:-Infinity, max:200, msg:"Redação: Não desista! Toda jornada começa com o primeiro passo. Pratique a escrita de textos dissertativos e analise redações nota 1000 para entender melhor a estrutura!"},
      {min:200, max:299, msg:"Redação: Você está progredindo! Foque na estrutura do texto e na sua linha de raciocínio. Ler e escrever com frequência vai ajudar a melhorar!"},
      {min:300, max:399, msg:"Redação: Bom começo! Tente desenvolver melhor seus argumentos e ampliar seu repertório cultural. Leia editoriais, notícias e artigos de opinião para fortalecer suas ideias."},
      {min:400, max:499, msg:"Redação: Seu texto tem potencial! Aprofundar sua argumentação e apresentar uma boa proposta de intervenção, viável e coerente com os argumentos apresentados, ajudará a elevar sua nota."},
      {min:500, max:599, msg:"Redação: Bom trabalho! Você já compreende bem a estrutura da redação. Agora, foque na progressão textual e no aprimoramento da proposta de intervenção, que deve conter: agente, ação, modo/meio, efeito/finalidade e detalhamento."},
      {min:600, max:699, msg:"Redação: Muito bem! Sua redação está bem desenvolvida. Continue refinando a argumentação e explorando referências para tornar seu texto ainda mais aprimorado, apresentando uma proposta de intervenção viável e coerente com os argumentos apresentados."},
      {min:700, max:799, msg:"Redação: Parabéns! Sua escrita é clara e bem organizada. Para alcançar um nível ainda mais alto, busque aprofundar a análise crítica e verifique se sua proposta de intervenção apresenta os seguintes elementos: agente, ação, modo/meio, efeito/finalidade, detalhamento."},
      {min:800, max:899, msg:"Redação: Excelente! Sua argumentação e domínio da escrita são de alto nível. Continue praticando para alcançar a nota máxima!"},
      {min:900, max:null, msg:"Redação: Fantástico! Sua redação demonstra domínio total da estrutura, argumentação e coesão. Seu nível de escrita é digno de nota máxima. Continue se aprimorando e inspirando outros com seu talento!"}
    ], "Redação: sem nota registrada.");
  }

  /* ===== PDF (pdf-lib) com gráfico (Chart.js) ===== */
  async function gerarPDF(){
    if (!ultimoResultado) return;

    const { PDFDocument, rgb, StandardFonts } = PDFLib;
    const doc  = await PDFDocument.create();
    let   page = doc.addPage([595.28, 841.89]); // A4 retrato
    const font = await doc.embedFont(StandardFonts.Helvetica);
    const draw = (p, txt, x, y, size=12)=> p.drawText(String(txt), { x, y, size, font, color: rgb(0,0,0) });

    /* ==== helpers de layout (dentro do gerarPDF) ==== */
    const MARGIN_X = 40;
    const MARGIN_BOTTOM = 40;
    let   y = 800;
    const CONTENT_W = page.getWidth() - MARGIN_X * 2;

    function splitIntoLines(text, size = 12, maxWidth = CONTENT_W) {
      const words = String(text || '').trim().split(/\s+/);
      const lines = [];
      let line = '';
      for (const w of words) {
        const test = line ? line + ' ' + w : w;
        if (font.widthOfTextAtSize(test, size) <= maxWidth) {
          line = test;
        } else {
          if (line) lines.push(line);
          let rest = w;
          while (font.widthOfTextAtSize(rest, size) > maxWidth && rest.length > 1) {
            let cut = rest.length - 1;
            while (cut > 1 && font.widthOfTextAtSize(rest.slice(0, cut), size) > maxWidth) cut--;
            lines.push(rest.slice(0, cut));
            rest = rest.slice(cut);
          }
          line = rest;
        }
      }
      if (line) lines.push(line);
      return lines;
    }

    function ensureSpace(linesCount, size = 12, lineHeight = Math.round(size * 1.25)) {
      const needed = linesCount * lineHeight + 6;
      if (y - needed < MARGIN_BOTTOM) {
        page = doc.addPage([595.28, 841.89]);
        y = page.getHeight() - MARGIN_BOTTOM;
      }
    }

    function drawBullet(text, size = 12) {
      const lineHeight = Math.round(size * 1.25);
      const bullet = '• ';
      const indent = font.widthOfTextAtSize(bullet, size);
      const lines = splitIntoLines(text, size, CONTENT_W - indent);

      ensureSpace(lines.length, size, lineHeight);

      // primeira linha
      y -= lineHeight;
      draw(page, bullet + (lines[0] || ''), MARGIN_X, y, size);
      // linhas seguintes com recuo
      for (let i = 1; i < lines.length; i++) {
        y -= lineHeight;
        draw(page, lines[i], MARGIN_X + indent, y, size);
      }
    }
    /* ==== /helpers ==== */

    const j = ultimoResultado;

    // Cabeçalho
    draw(page, 'Resultado ENEM', 40, y, 18); y-=24;
    draw(page, `Aluno: ${ (j.aluno&&j.aluno.nome) || '-' }`, 40, y); y-=16;
    draw(page, `Inscrição: ${j.inscricao}   Unidade: ${(j.aluno&&j.aluno.unidadeNome)||'-'}`, 40, y); y-=20;

    const A = j.areas || {}, R = j.redacao || {};
    const C = j.classificacao || {};

    [
      ['Linguagens', A.linguagens], ['Humanas', A.humanas],
      ['Natureza', A.natureza], ['Matemática', A.matematica],
      ['Redação (total)', R.total],
      ['CLS_G', C.cls_g ?? j.cls_g],
      ['CLS_U', C.cls_u ?? j.cls_u]
    ].forEach(([k,v]) => { draw(page, `${k}: ${v ?? '-'}`, 40, y); y -= 14; });

    // Gráfico
    const chartUrl = await makeChartImage(A, R);
    if (chartUrl){
      const chartBytes = dataURLtoBytes(chartUrl);
      const chartImg = await doc.embedPng(chartBytes);
      const w = 500, h = 230;
      page.drawImage(chartImg, { x: 40, y: y - h - 10, width: w, height: h });
      y -= (h + 20);
    }

    // Mensagens com bullets (quebra automática)
    const msgs = getMessages(A, R);
    [msgs.linguagens, msgs.humanas, msgs.natureza, msgs.matematica, msgs.redacao]
      .forEach(m => { drawBullet(m, 12); y -= 4; });

    // Salvar
    const bytes = await doc.save();
    const blob = new Blob([bytes], { type:'application/pdf' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `resultado_ENEM_${j.inscricao}.pdf`;
    a.click();
  }

  /* ===== helpers gerais ===== */
  function val(x){ return (x==null?'-':x); }
  function dataURLtoBytes(dataURL){
    const base64 = dataURL.split(',')[1];
    const bin = atob(base64); const len = bin.length;
    const bytes = new Uint8Array(len);
    for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
    return bytes;
  }

  async function makeChartImage(A, R){
    const el = document.getElementById('grafico');
    if (!el) return null;
    if (window._chartInst) { window._chartInst.destroy(); }

    const labels = ['LING', 'HUM', 'NAT', 'MAT', 'RED'];
    const data = [A.linguagens ?? null, A.humanas ?? null, A.natureza ?? null, A.matematica ?? null, R.total ?? null];

    window._chartInst = new Chart(el.getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ label:'Notas', data }] },
      options: { responsive: false, animation: false, scales: { y: { suggestedMin: 0, suggestedMax: 1000 } } }
    });

    await new Promise(r=>setTimeout(r, 50));
    return el.toDataURL('image/png');
  }
  </script>
</body>
</html>
