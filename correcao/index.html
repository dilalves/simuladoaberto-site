<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Login - Correção de Redações</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Materialize CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js"></script>

  <style>
    body { background: #f7f9fc; }
    .login-card {
      max-width: 400px;
      margin: 60px auto;
      padding: 32px;
      border-radius: 12px;
    }
  </style>
</head>
<body>

<div class="card login-card z-depth-3">
  <div class="card-content">
    <span class="card-title center">Correção de Redações</span>
    <div class="row">
      <div class="input-field col s12">
        <input id="login" type="text" required autocomplete="username">
        <label for="login">Usuário</label>
      </div>
      <div class="input-field col s12">
        <input id="senha" type="password" required autocomplete="current-password">
        <label for="senha">Senha</label>
      </div>
    </div>
    <div class="center">
      <button id="btnEntrar" class="btn blue waves-effect">Entrar</button>
    </div>
  </div>
</div>

<script>
  // Configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAdT93I_BPZEreuJGqx20r8cWP_81OsAk",
    authDomain: "redacao-enem-cd678.firebaseapp.com",
    projectId: "redacao-enem-cd678",
    storageBucket: "redacao-enem-cd678.appspot.com",
    messagingSenderId: "193249946367",
    appId: "1:193249946367:web:7baabd56fb5185a97fcc1f"
  };

  // Inicializa o Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  document.addEventListener('DOMContentLoaded', () => {
    if (window.M && M.updateTextFields) M.updateTextFields();
    const btn = document.getElementById('btnEntrar');

    async function doLogin() {
      const login = document.getElementById('login').value.trim();
      const senha = document.getElementById('senha').value.trim();

      if (!login || !senha) {
        M.toast({ html: 'Preencha login e senha!' });
        return;
      }

      btn.classList.add('disabled');

      try {
        const querySnapshot = await db.collection('corretores')
          .where('login', '==', login)
          .where('ativo', '==', true)
          .get();

        if (querySnapshot.empty) {
          M.toast({ html: 'Usuário não encontrado ou inativo!' });
          btn.classList.remove('disabled');
          return;
        }

        const doc = querySnapshot.docs[0];
        const dados = doc.data();
        const hash = await sha256(senha);

        if (dados.senha_hash !== hash) {
          M.toast({ html: 'Senha incorreta!' });
          btn.classList.remove('disabled');
          return;
        }

        // Login bem-sucedido
        localStorage.setItem('tok_corr', doc.id);
        localStorage.setItem('nome_corr', dados.nome);
        localStorage.setItem('cod_corr', dados.codund);
        location.href = './app.html';

      } catch (e) {
        console.error(e);
        M.toast({ html: 'Erro de login!' });
        btn.classList.remove('disabled');
      }
    }

    async function sha256(texto) {
      const enc = new TextEncoder();
      const buffer = await crypto.subtle.digest('SHA-256', enc.encode(texto));
      return [...new Uint8Array(buffer)]
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    btn.addEventListener('click', (e) => { e.preventDefault(); doLogin(); });
    ['login', 'senha'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', ev => {
        if (ev.key === 'Enter') { ev.preventDefault(); doLogin(); }
      });
    });
  });
</script>

</body>
</html>
