<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Login - Correção de Redações</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Materialize CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <style>
    body { background: #f7f9fc; }
    .login-card {
      max-width: 400px;
      margin: 60px auto;
      padding: 32px;
      border-radius: 12px;
    }
  </style>
</head>
<body>

  <div class="card login-card z-depth-3">
    <div class="card-content">
      <span class="card-title center">Login do Corretor</span>
      <div class="row">
        <div class="input-field col s12">
          <input id="login" type="text" required autocomplete="username">
          <label for="login">Usuário</label>
        </div>
        <div class="input-field col s12">
          <input id="senha" type="password" required autocomplete="current-password">
          <label for="senha">Senha</label>
        </div>
      </div>
      <div class="center">
        <!-- antes: <a id="btnEntrar" class="btn blue waves-effect">Entrar</a> -->
        <button id="btnEntrar" class="btn blue waves-effect">Entrar</button>
      </div>
    </div>
  </div>

  <!-- Materialize JS -->
 <script>
  document.addEventListener('DOMContentLoaded', () => {
    if (window.M && M.updateTextFields) M.updateTextFields();

    const GAS_BASE = 'https://script.google.com/macros/s/AKfycbwwVf2cI1AgvUF6LgV9LYPhM1jNDFSQNdoB3YrzRCHXJBV-S-XEcC5iKVWV8_egNouq/exec';
    const ORIGIN = location.origin;

    const btn = document.getElementById('btnEntrar');
    const doLogin = async () => {
      const login = document.getElementById('login').value.trim();
      const senha = document.getElementById('senha').value.trim();
      if (!login || !senha) { M.toast({html: 'Preencha login e senha!'}); return; }

      try {
        btn.classList.add('disabled');

        const body = new URLSearchParams({ login, senha }).toString();
        const r = await fetch(`${GAS_BASE}?action=login&origin=${encodeURIComponent(ORIGIN)}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });

        const j = await r.json();

        if (!r.ok || !j.ok) {
          M.toast({html: j?.error ? `Erro: ${j.error}` : 'Login inválido'});
          btn.classList.remove('disabled');
          return;
        }

        localStorage.setItem('tok_corr', j.token);
        localStorage.setItem('nome_corr', j.nome);
        localStorage.setItem('cod_corr', j.codUnidade);
        location.href = './app.html';
      } catch (err) {
        console.error(err);
        M.toast({html: 'Erro de conexão com servidor'});
        btn.classList.remove('disabled');
      }
    };

    btn.addEventListener('click', (e)=>{ e.preventDefault(); doLogin(); });
    // Enter para enviar
    ['login','senha'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', (ev)=>{
        if (ev.key === 'Enter') { ev.preventDefault(); doLogin(); }
      });
    });
  });
</script>

</body>
</html>

