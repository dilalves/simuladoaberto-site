<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Corrigir redação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; }
    .wrap { max-width:1100px; margin:24px auto; padding:0 12px; }
    .viewer { width:100%; height:70vh; border:0; background:#fff; }
  </style>
</head>
<body>
  <nav class="blue darken-3">
    <div class="nav-wrapper wrap">
      <a class="brand-logo" href="#!">Correção de Redações</a>
      <ul class="right">
        <li><a id="userLabel"></a></li>
        <li><a id="btnSair">Sair</a></li>
      </ul>
    </div>
  </nav>

  <div class="wrap">
    <a href="./pendentes.html" class="btn-flat">&larr; Voltar</a>

    <div class="card">
      <div class="card-content">
        <span class="card-title">Redação <span id="idLabel"></span></span>
        <p><b>Inscrição:</b> <span id="insc"></span> — <b>Status:</b> <span id="status"></span></p>
      </div>

      <div class="card-content">
        <iframe id="viewer" class="viewer"></iframe>
      </div>

      <div class="card-content">
        <div class="row">
          <div class="input-field col s6 m2">
            <input id="c1" type="number" min="0" max="200" step="40" value="0">
            <label for="c1">C1 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c2" type="number" min="0" max="200" step="40" value="0">
            <label for="c2">C2 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c3" type="number" min="0" max="200" step="40" value="0">
            <label for="c3">C3 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c4" type="number" min="0" max="200" step="40" value="0">
            <label for="c4">C4 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c5" type="number" min="0" max="200" step="40" value="0">
            <label for="c5">C5 (0–200)</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="total" type="number" readonly value="0">
            <label for="total" class="active">Total</label>
          </div>
          <div class="input-field col s12">
            <textarea id="obs" class="materialize-textarea" rows="3"></textarea>
            <label for="obs">Observações</label>
          </div>
        </div>
        <div>
          <a id="btnIniciar" class="btn blue">Iniciar correção</a>
          <a id="btnSalvar"  class="btn green disabled">Salvar e finalizar</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const GAS_BASE = 'https://script.google.com/macros/s/AKfycbwwVf2cI1AgvUF6LgV9LYPhM1jNDFSQNdoB3YrzRCHXJBV-S-XEcC5iKVWV8_egNouq/exec';

    const tok  = localStorage.getItem('tok_corr');
    const nome = localStorage.getItem('nome_corr');
    if (!tok) { location.href = './'; return; }
    document.getElementById('userLabel').textContent = nome || '';
    document.getElementById('btnSair').onclick = () => { localStorage.clear(); location.href = './'; };

    const params = new URLSearchParams(location.search);
    const id = params.get('id') || '';
    if (!id) { M.toast({html:'ID inválido'}); location.href='./pendentes.html'; return; }

    const idLabel    = document.getElementById('idLabel');
    const insc       = document.getElementById('insc');
    const status     = document.getElementById('status');
    const viewer     = document.getElementById('viewer');
    const btnIniciar = document.getElementById('btnIniciar');
    const btnSalvar  = document.getElementById('btnSalvar');
    const obs        = document.getElementById('obs');

    // Competências
    const c1 = document.getElementById('c1');
    const c2 = document.getElementById('c2');
    const c3 = document.getElementById('c3');
    const c4 = document.getElementById('c4');
    const c5 = document.getElementById('c5');
    const total = document.getElementById('total');

    function soma(){
      const v = [c1,c2,c3,c4,c5].map(el => Number(el.value||0));
      total.value = v.reduce((a,b)=>a+b,0);
    }
    [c1,c2,c3,c4,c5].forEach(el => el.addEventListener('input', soma));
    if (window.M && M.updateTextFields) M.updateTextFields();
    soma();

    idLabel.textContent = id;

    function jsonp(action, qs, cb){
      const name = 'cb_'+action+'_'+Date.now();
      let scr;
      window[name] = (j)=>{ try{ cb(j); } finally{ delete window[name]; if (scr) scr.remove(); } };
      scr = document.createElement('script');
      scr.src = `${GAS_BASE}?action=${action}&token=${encodeURIComponent(tok)}&callback=${name}&${qs}&t=${Date.now()}`;
      scr.onerror = ()=> M.toast({html:'Erro de conexão'});
      document.body.appendChild(scr);
    }

    // carrega dados do item
    jsonp('item', 'id='+encodeURIComponent(id), (j)=>{
      if (!j || !j.ok) { M.toast({html: j?.error || 'Não encontrado'}); return; }
      insc.textContent = j.inscricao || '';
      status.textContent = j.status || '';
      viewer.src = j.link || '';
      if (j.status === 'EM TRATAMENTO') {
        btnSalvar.classList.remove('disabled');
        btnIniciar.classList.add('disabled');
      }
    });

    btnIniciar.onclick = ()=>{
      jsonp('lock', 'id='+encodeURIComponent(id), (j)=>{
        if (!j || !j.ok) { M.toast({html: j?.error || 'Falha ao iniciar'}); return; }
        status.textContent = j.status;
        btnSalvar.classList.remove('disabled');
        btnIniciar.classList.add('disabled');
        M.toast({html:'Em tratamento'});
      });
    };

    btnSalvar.onclick = ()=>{
      if (btnSalvar.classList.contains('disabled')) return;
      const vals = [c1,c2,c3,c4,c5].map(el=>Number(el.value||0));
      const ok = vals.every(v => v>=0 && v<=200 && v%40===0);
      if (!ok) { M.toast({html:'Cada competência deve ser 0, 40, 80, 120, 160 ou 200'}); return; }
      const vObs = obs.value || '';
      const qs = `id=${encodeURIComponent(id)}&c1=${vals[0]}&c2=${vals[1]}&c3=${vals[2]}&c4=${vals[3]}&c5=${vals[4]}&obs=${encodeURIComponent(vObs)}`;
      jsonp('submit', qs, (j)=>{
        if (!j || !j.ok) { M.toast({html: j?.error || 'Falha ao salvar'}); return; }
        M.toast({html:`Correção salva! Total ${j.total}`});
        setTimeout(()=> location.href='./pendentes.html', 600);
      });
    };
  });
  </script>
</body>
</html>
