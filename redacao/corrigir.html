<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Corrigir redação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet" />
  <style>
    body { background:#f7f9fc; }
    .wrap { max-width:1280px; margin:24px auto; padding:0 12px; }

    .viewer-wrap{ position:relative; }
    .viewer-canvas{ position:relative; display:inline-block; } /* <- tem o tamanho da imagem */
    .viewer-img {
        display:block;
        border:1px solid #e5e7eb;
        border-radius:10px;
        background:#fff;
        margin:0 auto;             /* centraliza */
      }
    .viewer-img.fill-screen {
        max-width:100%;
        max-height:none;            /* remove limite */
        object-fit:contain;         /* garante proporção */
      }

    .vloading{
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(255,255,255,.6); backdrop-filter:saturate(120%) blur(1px);
    }
    .vloading.hide{ display:none; }

    /* pinos das anotações */
    .pin{
      position:absolute; width:14px; height:14px;
      border-radius:50%; border:2px solid #fff; background:#e53935;
      box-shadow:0 1px 4px rgba(0,0,0,.3);
      transform:translate(-50%,-50%); cursor:pointer;
    }
  </style>
</head>
<body>
  <nav class="blue darken-3">
    <div class="nav-wrapper wrap">
      <a class="brand-logo" href="#!">Correção de Redações</a>
      <ul class="right">
        <li><a id="userLabel"></a></li>
        <li><a id="btnSair">Sair</a></li>
      </ul>
    </div>
  </nav>

  <div class="wrap">
    <a href="./pendentes.html" class="btn-flat">&larr; Voltar</a>

    <div class="card">
      <div class="card-content">
        <span class="card-title">Redação <span id="idLabel"></span></span>
        <p><b>Inscrição:</b> <span id="insc"></span> — <b>Status:</b> <span id="status"></span></p>
        <div>
          <a id="btnIniciar" class="btn blue">Iniciar correção</a>
        </div>  
      </div>

      <div class="card-content">
        <div id="viewerWrap" class="viewer-wrap">
          <div id="vloading" class="vloading">
            <div class="progress" style="width:240px; max-width:80%"><div class="indeterminate"></div></div>
            <div class="grey-text text-darken-1" style="margin-top:8px">Carregando redação…</div>
          </div>

          <!-- canvas = contêiner que agrupa imagem + pins (e recebe zoom) -->
          <div id="canvas" class="viewer-canvas">
            <img id="viewer" class="viewer-img fill-screen"
                 alt="Redação" referrerpolicy="no-referrer" decoding="async" />
          </div>

          <!-- Modal de anotação -->
          <div id="notaModal" class="modal">
            <div class="modal-content">
              <h5>Anotação</h5>
              <p class="grey-text text-darken-1" id="notaPos"></p>
              <div class="input-field">
                <textarea id="notaTexto" class="materialize-textarea" rows="3" placeholder="Escreva a observação…"></textarea>
                <label for="notaTexto">Observação</label>
              </div>
            </div>
            <div class="modal-footer">
              <a href="#!" id="notaSalvar" class="modal-close btn green">Salvar</a>
              <a href="#!" class="modal-close btn-flat">Cancelar</a>
            </div>
          </div>
        </div>
      </div>

      <div class="card-content">
        <div class="row">
          <div class="input-field col s6 m2">
            <input id="c1" type="number" min="0" max="200" step="40" value="0" />
            <label for="c1">C1 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c2" type="number" min="0" max="200" step="40" value="0" />
            <label for="c2">C2 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c3" type="number" min="0" max="200" step="40" value="0" />
            <label for="c3">C3 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c4" type="number" min="0" max="200" step="40" value="0" />
            <label for="c4">C4 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c5" type="number" min="0" max="200" step="40" value="0" />
            <label for="c5">C5 (0–200)</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="total" type="number" readonly value="0" />
            <label for="total" class="active">Total</label>
          </div>
          <div class="input-field col s12">
            <textarea id="obs" class="materialize-textarea" rows="3"></textarea>
            <label for="obs">Observações</label>
          </div>
        </div>
        <div>
          
          <a id="btnSalvar"  class="btn green disabled">Salvar e finalizar</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API = 'https://api.secauxiliar.com.br';
    const SESS_KEY = 'sessao_redacao';

    // ------- elementos -------
    const userLabel  = document.getElementById('userLabel');
    const btnSair    = document.getElementById('btnSair');
    const idLabel    = document.getElementById('idLabel');
    const insc       = document.getElementById('insc');
    const statusEl   = document.getElementById('status');

    const viewerWrap = document.getElementById('viewerWrap');
    const canvas     = document.getElementById('canvas');
    const vloading   = document.getElementById('vloading');
    const imgEl      = document.getElementById('viewer');

    const btnIniciar = document.getElementById('btnIniciar');
    const btnSalvar  = document.getElementById('btnSalvar');
    const obs        = document.getElementById('obs');
    const c1 = document.getElementById('c1');
    const c2 = document.getElementById('c2');
    const c3 = document.getElementById('c3');
    const c4 = document.getElementById('c4');
    const c5 = document.getElementById('c5');
    const total      = document.getElementById('total');

    // ------- sessão/token -------
    function sess(){ try { return JSON.parse(localStorage.getItem(SESS_KEY)||'{}'); } catch(_){ return {}; } }
    function authHeaders(){
      const t = (sess().token) || localStorage.getItem('tok_corr') || '';
      return t ? {'Authorization':'Bearer '+t, 'Content-Type':'application/json'} : {'Content-Type':'application/json'};
    }
    function logout(){
      localStorage.removeItem(SESS_KEY);
      localStorage.removeItem('tok_corr');
      localStorage.removeItem('nome_corr');
      localStorage.removeItem('cod_corr');
      location.href = './';
    }

    const nome = (sess().usuario && sess().usuario.nome) || localStorage.getItem('nome_corr') || '';
    if (!((sess() && sess().token) || localStorage.getItem('tok_corr'))) { location.href='./'; return; }
    userLabel.textContent = nome;
    btnSair.onclick = logout;

    const params = new URLSearchParams(location.search);
    const id = params.get('id') || params.get('rid');
    if (!id) { M.toast({html:'ID inválido'}); location.href='./pendentes.html'; return; }
    idLabel.textContent = id;

    // ------- soma / total -------
    function soma(){
      const v = [c1,c2,c3,c4,c5].map(el => Number(el.value||0));
      total.value = v.reduce((a,b)=>a+b,0);
      if (window.M && M.updateTextFields) M.updateTextFields();
    }
    [c1,c2,c3,c4,c5].forEach(el => el.addEventListener('input', soma));
    soma();

    // ------- dimensionamento proporcional -------
    let naturalW = 0, naturalH = 0;
    function fitImage(){
      if(!naturalW || !naturalH) return;

      const availW = viewerWrap.clientWidth;

      // escala só pela largura disponível
      const scale = availW / naturalW;

      imgEl.style.width  = Math.floor(naturalW * scale) + 'px';
      imgEl.style.height = Math.floor(naturalH * scale) + 'px';
    }

    window.addEventListener('resize', () => { fitImage(); renderPins(); });

    imgEl.onload = () => {
      naturalW = imgEl.naturalWidth;
      naturalH = imgEl.naturalHeight;
      fitImage();
      vloading.classList.add('hide');
    };
    imgEl.onerror = () => {
      vloading.classList.add('hide');
      M.toast({html:'Falha ao carregar imagem'});
    };

    // ------- anotações (pinos) -------
    const notaModal  = document.getElementById('notaModal');
    const notaTexto  = document.getElementById('notaTexto');
    const notaPos    = document.getElementById('notaPos');
    const notaSalvar = document.getElementById('notaSalvar');
    M.Modal.init(notaModal);

    const pins = []; // {xPct, yPct, texto}
    let clickBuffer = null;

    function renderPins(){
      [...canvas.querySelectorAll('.pin')].forEach(el => el.remove());
      pins.forEach((p, idx) => {
        const el = document.createElement('div');
        el.className = 'pin';
        el.title = p.texto || `#${idx+1}`;
        el.style.left = `${p.xPct}%`;
        el.style.top  = `${p.yPct}%`;
        el.onclick = () => M.toast({html: el.title || '(sem texto)'}); // preview simples
        canvas.appendChild(el);
      });
    }
    function clickToPercents(evt){
      const r = imgEl.getBoundingClientRect();
      const x = evt.clientX - r.left;
      const y = evt.clientY - r.top;
      return {
        xPct: Math.max(0, Math.min(100, (x / imgEl.clientWidth)  * 100)),
        yPct: Math.max(0, Math.min(100, (y / imgEl.clientHeight) * 100)),
      };
    }
    imgEl.addEventListener('click', (evt) => {
      clickBuffer = clickToPercents(evt);
      notaTexto.value = '';
      if (M.updateTextFields) M.updateTextFields();
      notaPos.textContent = `Posição: ${clickBuffer.xPct.toFixed(1)}% × ${clickBuffer.yPct.toFixed(1)}%`;
      M.Modal.getInstance(notaModal).open();
    });
    notaSalvar.addEventListener('click', () => {
      if (!clickBuffer) return;
      pins.push({ ...clickBuffer, texto: (notaTexto.value || '').trim() });
      clickBuffer = null;
      renderPins();
      M.toast({html:'Anotação salva'});
    });

    // ------- carregar item -------
    (async function loadItem(){
      try{
        vloading.classList.remove('hide');
        const res = await fetch(`${API}/correcoes_item.php?id=${encodeURIComponent(id)}`, { headers: { ...authHeaders() }});
        if (res.status === 401 || res.status === 403) { logout(); return; }
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j?.error || `HTTP_${res.status}`);

        insc.textContent     = j.inscricao || '';
        statusEl.textContent = j.status || 'Pendente';

        if (j.link) {
          imgEl.src = `${API}/arquivo_proxy.php?id=${encodeURIComponent(j.id)}&v=${Date.now()}`;
        } else {
          imgEl.src = `${API}/arquivo_view.php?id=${encodeURIComponent(j.id)}&v=${Date.now()}`;
        }

        if ((j.status||'').toLowerCase().includes('tratamento')) {
          btnSalvar.classList.remove('disabled');
          btnIniciar.classList.add('disabled');
        }

        if (j.correcoes) {
          const { c1:vc1=0, c2:vc2=0, c3:vc3=0, c4:vc4=0, c5:vc5=0 } = j.correcoes;
          c1.value=vc1; c2.value=vc2; c3.value=vc3; c4.value=vc4; c5.value=vc5;
          soma();
        }

        // se backend devolver notas
        if (Array.isArray(j.notas)) {
          pins.length = 0;
          j.notas.forEach(n => pins.push({
            xPct: Number(n.xPct),
            yPct: Number(n.yPct),
            texto: n.texto || ''
          }));
          renderPins();
        }

      }catch(e){
        console.error(e);
        M.toast({html: e.message || 'Falha ao carregar item'});
        vloading.classList.add('hide');
      }
    })();

    // ------- iniciar (lock) -------
    btnIniciar.onclick = async () => {
      try{
        const res = await fetch(`${API}/correcoes_lock.php`, {
          method:'POST', headers:{ ...authHeaders() }, body: JSON.stringify({ id })
        });
        if (res.status === 401 || res.status === 403) { logout(); return; }
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j?.error || 'Falha ao iniciar');

        statusEl.textContent = j.status || 'Em tratamento';
        btnSalvar.classList.remove('disabled');
        btnIniciar.classList.add('disabled');
        M.toast({html:'Em tratamento'});
      }catch(e){
        M.toast({html: e.message || 'Falha ao iniciar'});
      }
    };

    // ------- salvar (finalizar) -------
    btnSalvar.onclick = async () => {
      if (btnSalvar.classList.contains('disabled')) return;

      const vals = [c1,c2,c3,c4,c5].map(el=>Number(el.value||0));
      const ok = vals.every(v => v>=0 && v<=200 && v%40===0);
      if (!ok) { M.toast({html:'Cada competência deve ser 0, 40, 80, 120, 160 ou 200'}); return; }

      try{
        btnSalvar.classList.add('disabled');

        const res = await fetch(`${API}/correcoes_submit.php`, {
          method:'POST',
          headers:{ ...authHeaders() },
          body: JSON.stringify({
            id,
            c1:vals[0], c2:vals[1], c3:vals[2], c4:vals[3], c5:vals[4],
            obs: (obs.value || ''),
            notas: pins                 // << envia os pins
          })
        });

        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j?.message || j?.error || 'Falha ao salvar');

        M.toast({html:`Correção salva! Total ${j.total}`});
        setTimeout(()=> location.href='./pendentes.html', 600);
      }catch(e){
        M.toast({html: e.message || 'Falha ao salvar'});
        btnSalvar.classList.remove('disabled');
      }
    };

    // atalhos
    [c1,c2,c3,c4,c5].forEach(el => {
      el.addEventListener('keydown', (e) => {
        const cur = Number(el.value || 0);
        if (e.key === 'ArrowUp')   { e.preventDefault(); el.value = Math.min(200, cur + 40); soma(); }
        if (e.key === 'ArrowDown') { e.preventDefault(); el.value = Math.max(0,   cur - 40); soma(); }
      });
    });
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        if (!btnSalvar.classList.contains('disabled')) btnSalvar.click();
      }
    });

    // ====== ZOOM COM SCROLL (CTRL + roda) ======
    let zoom = 1;
    function applyZoom(){
      canvas.style.transform = `scale(${zoom})`;
      canvas.style.transformOrigin = 'top center';
      canvas.style.willChange = 'transform';
    }
    canvas.addEventListener('wheel', (e) => {
      if (!e.ctrlKey) return;
      e.preventDefault();
      const step = (e.deltaY < 0) ? 1.1 : 0.9;
      zoom = Math.max(0.5, Math.min(3, zoom * step));
      applyZoom();
    }, { passive:false });
    canvas.addEventListener('dblclick', () => { zoom = 1; applyZoom(); });
  });
  </script>
</body>
</html>
