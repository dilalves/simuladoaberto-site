<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Corrigir redação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    body { background:#f7f9fc; }
    .wrap { max-width:1100px; margin:24px auto; padding:0 12px; }
    .viewer { width:100%; height:70vh; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
    .vloading{
      position:absolute; inset:0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(255,255,255,.6); backdrop-filter:saturate(120%) blur(1px);
    }
    .vloading.hide{ display:none; }
  </style>
</head>
<body>
  <nav class="blue darken-3">
    <div class="nav-wrapper wrap">
      <a class="brand-logo" href="#!">Correção de Redações</a>
      <ul class="right">
        <li><a id="userLabel"></a></li>
        <li><a id="btnSair">Sair</a></li>
      </ul>
    </div>
  </nav>

  <div class="wrap">
    <a href="./pendentes.html" class="btn-flat">&larr; Voltar</a>

    <div class="card">
      <div class="card-content">
        <span class="card-title">Redação <span id="idLabel"></span></span>
        <p><b>Inscrição:</b> <span id="insc"></span> — <b>Status:</b> <span id="status"></span></p>
      </div>

      <div class="card-content">
        <div id="vwrap" style="position:relative">
          <div id="vloading" class="vloading">
            <div class="progress" style="width:240px; max-width:80%"><div class="indeterminate"></div></div>
            <div class="grey-text text-darken-1" style="margin-top:8px">Carregando redação…</div>
          </div>
          <!-- viewer da redação (abre arquivo_view.php, que aponta p/ Google Drive) -->
          <iframe id="viewer" class="viewer" referrerpolicy="no-referrer" loading="lazy"></iframe>
        </div>
      </div>

      <div class="card-content">
        <div class="row">
          <div class="input-field col s6 m2">
            <input id="c1" type="number" min="0" max="200" step="40" value="0">
            <label for="c1">C1 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c2" type="number" min="0" max="200" step="40" value="0">
            <label for="c2">C2 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c3" type="number" min="0" max="200" step="40" value="0">
            <label for="c3">C3 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c4" type="number" min="0" max="200" step="40" value="0">
            <label for="c4">C4 (0–200)</label>
          </div>
          <div class="input-field col s6 m2">
            <input id="c5" type="number" min="0" max="200" step="40" value="0">
            <label for="c5">C5 (0–200)</label>
          </div>
          <div class="input-field col s12 m2">
            <input id="total" type="number" readonly value="0">
            <label for="total" class="active">Total</label>
          </div>
          <div class="input-field col s12">
            <textarea id="obs" class="materialize-textarea" rows="3"></textarea>
            <label for="obs">Observações</label>
          </div>
        </div>
        <div>
          <a id="btnIniciar" class="btn blue">Iniciar correção</a>
          <a id="btnSalvar"  class="btn green disabled">Salvar e finalizar</a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API = 'https://api.secauxiliar.com.br';
    const SESS_KEY = 'sessao_redacao';

    const userLabel = document.getElementById('userLabel');
    const btnSair   = document.getElementById('btnSair');

    // sessão/token
    function sess(){ try { return JSON.parse(localStorage.getItem(SESS_KEY)||'{}'); } catch(_){ return {}; } }
    function authHeaders(){
      const t = (sess().token) || localStorage.getItem('tok_corr') || '';
      return t ? {'Authorization':'Bearer '+t, 'Content-Type':'application/json'} : {'Content-Type':'application/json'};
    }
    function logout(){
      localStorage.removeItem(SESS_KEY);
      localStorage.removeItem('tok_corr');
      localStorage.removeItem('nome_corr');
      localStorage.removeItem('cod_corr');
      location.href = './';
    }

    const nome = (sess().usuario && sess().usuario.nome) || localStorage.getItem('nome_corr') || '';
    if (!((sess() && sess().token) || localStorage.getItem('tok_corr'))) { location.href='./'; return; }
    userLabel.textContent = nome;
    btnSair.onclick = logout;

    const params = new URLSearchParams(location.search);
    const id = params.get('id') || params.get('rid');
    if (!id) { M.toast({html:'ID inválido'}); location.href='./pendentes.html'; return; }

    // refs
    const idLabel = document.getElementById('idLabel');
    const insc    = document.getElementById('insc');
    const status  = document.getElementById('status');
    const viewer  = document.getElementById('viewer');
    const vloading= document.getElementById('vloading');

    const btnIniciar = document.getElementById('btnIniciar');
    const btnSalvar  = document.getElementById('btnSalvar');
    const obs        = document.getElementById('obs');
    const c1 = document.getElementById('c1');
    const c2 = document.getElementById('c2');
    const c3 = document.getElementById('c3');
    const c4 = document.getElementById('c4');
    const c5 = document.getElementById('c5');
    const total = document.getElementById('total');

    // soma e mantém label ativa
    function soma(){
      const v = [c1,c2,c3,c4,c5].map(el => Number(el.value||0));
      total.value = v.reduce((a,b)=>a+b,0);
      if (window.M && M.updateTextFields) M.updateTextFields();
    }
    [c1,c2,c3,c4,c5].forEach(el => el.addEventListener('input', soma));
    soma();

    idLabel.textContent = id;

    // overlay: esconde ao carregar o iframe ou se falhar
    viewer.addEventListener('load', ()=> vloading.classList.add('hide'));
    viewer.addEventListener('error',()=> vloading.classList.add('hide'));

    // carrega dados do item
    (async function loadItem(){
      try{
        vloading.classList.remove('hide');
        const res = await fetch(`${API}/correcoes_item.php?id=${encodeURIComponent(id)}`, { headers: { ...authHeaders() }});
        if (res.status === 401 || res.status === 403) { logout(); return; }
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j?.error || `HTTP_${res.status}`);

        insc.textContent   = j.inscricao || '';
        status.textContent = j.status || 'Pendente';

        // Renderiza direto a imagem do Drive dentro do iframe (sem passar por arquivo_view.php)
        if (j.link) {
          const esc = s => String(s)
            .replace(/&/g,'&amp;').replace(/"/g,'&quot;')
            .replace(/</g,'&lt;').replace(/>/g,'&gt;');
          viewer.removeAttribute('src'); // garante que o iframe recarregue pelo srcdoc
          viewer.srcdoc = `
        <!doctype html>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <style>
          html,body{height:100%;margin:0;background:#fff}
          .wrap{min-height:100%;display:flex;align-items:flex-start;justify-content:center}
          img{max-width:100%;height:auto;display:block}
        </style>
        <div class="wrap">
          <img src="${esc(j.link)}" alt="Redação">
        </div>`;
        } else {
          // fallback: usa seu viewer em PHP (com cache-buster)
          viewer.src = `${API}/arquivo_view.php?id=${encodeURIComponent(j.id)}&v=${Date.now()}`;
        }


        // libera salvar se já estiver em tratamento
        if ((j.status||'').toLowerCase().includes('tratamento')) {
          btnSalvar.classList.remove('disabled');
          btnIniciar.classList.add('disabled');
        }

        // preenche notas se vierem do backend
        if (j.correcoes) {
          const { c1:vc1=0, c2:vc2=0, c3:vc3=0, c4:vc4=0, c5:vc5=0 } = j.correcoes;
          c1.value=vc1; c2.value=vc2; c3.value=vc3; c4.value=vc4; c5.value=vc5;
          soma();
        }
      }catch(e){
        console.error(e);
        M.toast({html: e.message || 'Falha ao carregar item'});
        vloading.classList.add('hide');
      }
    })();

    // iniciar (lock)
    btnIniciar.onclick = async () => {
      try{
        const res = await fetch(`${API}/correcoes_lock.php`, {
          method:'POST', headers:{ ...authHeaders() },
          body: JSON.stringify({ id })
        });
        if (res.status === 401 || res.status === 403) { logout(); return; }
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j?.error || 'Falha ao iniciar');

        status.textContent = j.status || 'Em tratamento';
        btnSalvar.classList.remove('disabled');
        btnIniciar.classList.add('disabled');
        M.toast({html:'Em tratamento'});
      }catch(e){
        M.toast({html: e.message || 'Falha ao iniciar'});
      }
    };

    // salvar (finalizar)
    btnSalvar.onclick = async () => {
      if (btnSalvar.classList.contains('disabled')) return;

      const vals = [c1,c2,c3,c4,c5].map(el=>Number(el.value||0));
      const ok = vals.every(v => v>=0 && v<=200 && v%40===0);
      if (!ok) { M.toast({html:'Cada competência deve ser 0, 40, 80, 120, 160 ou 200'}); return; }

      try{
        btnSalvar.classList.add('disabled');
        const res = await fetch(`${API}/correcoes_submit.php`, {
          method:'POST', headers:{ ...authHeaders() },
          body: JSON.stringify({ id, c1:vals[0], c2:vals[1], c3:vals[2], c4:vals[3], c5:vals[4], obs: obs.value || '' })
        });
        if (res.status === 401 || res.status === 403) { logout(); return; }
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j?.error || 'Falha ao salvar');

        M.toast({html:`Correção salva! Total ${j.total}`});
        setTimeout(()=> location.href='./pendentes.html', 600);
      }catch(e){
        M.toast({html: e.message || 'Falha ao salvar'});
        btnSalvar.classList.remove('disabled');
      }
    };

    // atalhos de teclado
    [c1,c2,c3,c4,c5].forEach(el => {
      el.addEventListener('keydown', (e) => {
        const cur = Number(el.value || 0);
        if (e.key === 'ArrowUp')  { e.preventDefault(); el.value = Math.min(200, cur + 40); soma(); }
        if (e.key === 'ArrowDown'){ e.preventDefault(); el.value = Math.max(0,   cur - 40); soma(); }
      });
    });
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        if (!btnSalvar.classList.contains('disabled')) btnSalvar.click();
      }
    });
  });
  </script>
</body>
</html>
