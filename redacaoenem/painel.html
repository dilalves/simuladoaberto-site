<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel • Simulado ENEM - Redação</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3; --ink:#0f172a; --muted:#6b7280; --primary:#2563eb;
    }
    html,body{height:100%}
    body{background:var(--bg); color:var(--ink)}

    /* ===== Layout ===== */
    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh}
    .aside{background:#fff; border-right:1px solid var(--line)}
    .main{display:flex; flex-direction:column}

    /* Header */
    .topbar{background:#fff; border-bottom:1px solid var(--line)}
    .topbar .wrap{max-width:1300px; margin:0 auto; padding:12px 18px}
    .brand{font-weight:800; font-size:1.2rem; margin-right:16px}
    .unit{color:var(--muted); font-weight:600}
    .user-chip{background:#eef2ff; border-radius:12px; padding:8px 12px; color:#1e293b}

    /* Aside */
    .aside .logo{display:flex; align-items:center; gap:10px; padding:18px}
    .aside .logo .tick{background:#e0ebff; color:#1d4ed8; width:26px; height:26px; border-radius:6px; display:flex; align-items:center; justify-content:center}
    .menu a{display:flex; align-items:center; gap:12px; padding:12px 18px; color:#111827; border-radius:10px; margin:6px 12px; font-weight:600}
    .menu a:hover{background:#eef2ff}
    .menu a.active{background:#e7efff; color:#1d4ed8}

    /* Content */
    .content{max-width:1200px; margin:0 auto; padding:20px}
    .selector-row{margin:6px 0 14px}

    /* Cards */
    .card.edge{border-radius:14px; border:1px solid var(--line)}
    .kpi .card-content{padding:22px}
    .kpi .value{font-size:2.1rem; font-weight:800}
    .kpi .label{color:var(--muted); margin-top:4px}

    .action .card-content{padding:26px; text-align:center}
    .action .material-icons{font-size:50px; color:var(--primary); opacity:.95}
    .action .title{margin-top:10px; font-weight:800; font-size:1.5rem}

    .small-actions .card .card-content{padding:16px; text-align:center}

    @media(max-width:992px){
      .app{grid-template-columns:1fr}
      .aside{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ===== Aside / Menu ===== -->
    <aside class="aside">
      <div class="logo">
        <div class="tick"><i class="material-icons" style="font-size:18px">check</i></div>
        <div style="font-weight:800">Redação Online</div>
      </div>
      <nav class="menu">
        <a class="active" href="#"><i class="material-icons">dashboard</i>Dashboard</a>
        <a href="envio.html"><i class="material-icons">description</i>Envio de Redações</a>
        <a href="professores.html"><i class="material-icons">group</i>Professores</a>
        <a href="relatorios.html"><i class="material-icons">insert_chart_outlined</i>Relatórios</a>
        <a href="config.html"><i class="material-icons">settings</i>Configurações</a>
      </nav>
    </aside>

    <!-- ===== Main ===== -->
    <section class="main">
      <!-- Header -->
      <div class="topbar">
        <div class="wrap">
          <div class="row valign-wrapper" style="margin-bottom:0">
            <div class="col s12 m6 left-align">
              <span class="brand">Redação Online</span>
              <span class="unit">• <span id="unitIdName">—</span></span>
            </div>
            <div class="col s12 m6 right-align">
              <span class="user-chip"><i class="material-icons left">account_circle</i><span id="userName">Usuário</span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Seletor de Simulado -->
        <div class="row selector-row">
          <div class="col s12 m6 l4">
            <label for="simuladoSelect" class="grey-text text-darken-1" style="font-weight:600">Simulado ENEM</label>
            <select id="simuladoSelect" class="browser-default" style="border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#fff">
              <option value="">Selecione...</option>
              <!-- preenchido via JS -->
            </select>
          </div>
        </div>

        <!-- KPIs -->
        <div class="row" style="margin-bottom:10px">
          <div class="col s12 m4">
            <div class="card edge kpi z-depth-0">
              <div class="card-content center">
                <div class="value" id="kpiInscritos">—</div>
                <div class="label">Inscritos</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge kpi z-depth-0">
              <div class="card-content center">
                <div class="value" id="kpiEnviadas">—</div>
                <div class="label">Redações enviadas</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge kpi z-depth-0">
              <div class="card-content center">
                <div class="value" id="kpiCorretores">—</div>
                <div class="label">Corretores</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações (3 médios: Enviar, Corretores, Conferir envio) -->
        <div class="row">
          <div class="col s12 m4">
            <div class="card edge action hoverable">
              <div class="card-content">
                <i class="material-icons">cloud_upload</i>
                <div class="title">Enviar redação</div>
                <p class="grey-text">Imagens ou PDF • Lote permitido</p>
              </div>
              <div class="card-action center">
                <a href="envio.html" class="btn waves-effect waves-light blue darken-2"><i class="material-icons left">arrow_forward</i>Abrir envio</a>
              </div>
            </div>
          </div>

          <div class="col s12 m4">
            <div class="card edge action hoverable">
              <div class="card-content">
                <i class="material-icons">face</i>
                <div class="title">Corretores</div>
                <p class="grey-text">Gerencie professores da unidade</p>
              </div>
              <div class="card-action center">
                <a href="professores.html" class="btn-flat">Abrir</a>
              </div>
            </div>
          </div>

          <div class="col s12 m4">
            <div class="card edge action hoverable">
              <div class="card-content">
                <i class="material-icons">search</i>
                <div class="title">Conferir envio</div>
                <p class="grey-text">Validar inscrição manualmente (falhas de OMR)</p>
              </div>
              <div class="card-action center">
                <a href="conferir-envio.html" class="btn-flat">Abrir</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações menores (opcionais) -->
        <div class="row small-actions">
          <div class="col s12 m4">
            <div class="card edge z-depth-0 hoverable">
              <div class="card-content">
                <i class="material-icons">east</i>
                <div style="font-weight:700">Enviar redação</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge z-depth-0 hoverable">
              <div class="card-content">
                <i class="material-icons">badge</i>
                <div style="font-weight:700">Cadastrar professor</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge z-depth-0 hoverable">
              <div class="card-content">
                <i class="material-icons">settings</i>
                <div style="font-weight:700">Configurar unidade</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <script>
    // ===== CONFIG =====
    // Endpoint da API (ajuste para seu subdomínio real)
    const API = 'https://api.secauxiliar.com.br';

    // ===== Sessão (token/unidade/usuário) =====
    function getSession(){
      try { return JSON.parse(localStorage.getItem('sessao_redacao') || '{}'); }
      catch(e){ return {}; }
    }
    function setUnitHeader({ codigo, nome } = {}){
      const el = document.getElementById('unitIdName');
      if(!el) return;
      if(codigo && nome) el.textContent = `${codigo} - ${nome}`;
      else if(nome)      el.textContent = nome;
      else               el.textContent = '—';
    }

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', async () => {
      const sess = getSession();

      // Usa dados do login (recomendado)
      if (sess?.unidade?.codigo && sess?.unidade?.nome) {
        setUnitHeader(sess.unidade);
        if (sess?.usuario?.nome) document.getElementById('userName').textContent = sess.usuario.nome;
      } else {
        // Ou carrega da API (ex.: /me)
        await carregarContextoDaAPI();
      }

      carregarSimulados();
    });

    // ===== Contexto da API =====
    async function carregarContextoDaAPI(){
      try{
        const sess = getSession();
        const headers = {};
        if (sess?.token) headers['Authorization'] = `Bearer ${sess.token}`;
        const res = await fetch(`${API}/me`, { headers, cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        // esperado: { usuario:{nome}, unidade:{codigo,nome} }
        if (data?.usuario?.nome) document.getElementById('userName').textContent = data.usuario.nome;
        if (data?.unidade) {
          setUnitHeader(data.unidade);
          const novaSessao = Object.assign({}, getSession(), data);
          localStorage.setItem('sessao_redacao', JSON.stringify(novaSessao));
        }
      } catch(e){ console.warn('Falha ao carregar contexto da API', e); }
    }

    // ===== Carrega seletor de simulados =====
    async function carregarSimulados(){
      try{
        const res = await fetch(`${API}/simulados`, { cache:'no-store' });
        const data = await res.json();
        const sel = document.getElementById('simuladoSelect');
        (data.simulados||[]).forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id; opt.textContent = s.nome;
          sel.appendChild(opt);
        });
        if((data.simulados||[]).length === 1){
          sel.value = data.simulados[0].id;
          onChangeSimulado();
        }
        sel.addEventListener('change', onChangeSimulado);
      }catch(err){ console.error('Falha ao carregar simulados', err); }
    }

    async function onChangeSimulado(){
      const simId = document.getElementById('simuladoSelect').value;
      if(!simId){ setKPIs({}); return; }
      await carregarKPIs(simId);
    }

    // ===== KPIs =====
    async function carregarKPIs(simuladoId){
      try{
        const res = await fetch(`${API}/dashboard/${encodeURIComponent(simuladoId)}`, { cache:'no-store' });
        const data = await res.json();
        // esperado: { ok:true, inscritos, enviadas, corretores, unidade:{codigo,nome}, usuario:{nome} }
        setKPIs(data);
      }catch(err){ console.error('Falha KPIs', err); }
    }

    function setKPIs({ inscritos='—', enviadas='—', corretores='—', unidade, usuario }={}){
      document.getElementById('kpiInscritos').textContent  = inscritos;
      document.getElementById('kpiEnviadas').textContent   = enviadas;
      document.getElementById('kpiCorretores').textContent = corretores;
      if (unidade?.codigo && unidade?.nome) setUnitHeader(unidade);
      if (usuario?.nome) document.getElementById('userName').textContent = usuario.nome;
    }
  </script>
</body>
</html>
