<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel • Simulado ENEM - Redação</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3; --ink:#0f172a; --muted:#6b7280; --primary:#2563eb;
    }
    html,body{height:100%}
    body{background:var(--bg); color:var(--ink)}

    /* ===== Layout ===== */
    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh}
    .aside{background:#fff; border-right:1px solid var(--line)}
    .main{display:flex; flex-direction:column}

    /* Header */
    .topbar{background:#fff; border-bottom:1px solid var(--line)}
    .topbar .wrap{max-width:1300px; margin:0 auto; padding:12px 18px}
    .brand{font-weight:800; font-size:1.2rem; margin-right:16px}
    .unit{color:var(--muted); font-weight:600}
    .user-chip{background:#eef2ff; border-radius:12px; padding:8px 12px; color:#1e293b}

    /* Aside */
    .aside .logo{display:flex; align-items:center; gap:10px; padding:18px}
    .aside .logo .tick{background:#e0ebff; color:#1d4ed8; width:26px; height:26px; border-radius:6px; display:flex; align-items:center; justify-content:center}
    .menu a{display:flex; align-items:center; gap:12px; padding:12px 18px; color:#111827; border-radius:10px; margin:6px 12px; font-weight:600}
    .menu a:hover{background:#eef2ff}
    .menu a.active{background:#e7efff; color:#1d4ed8}

    /* Content */
    .content{max-width:1200px; margin:0 auto; padding:20px}
    .selector-row{margin:6px 0 14px}

    /* Cards */
    .card.edge{border-radius:14px; border:1px solid var(--line)}
    .kpi .card-content{padding:22px}
    .kpi .value{font-size:2.1rem; font-weight:800}
    .kpi .label{color:var(--muted); margin-top:4px}

    .action .card-content{padding:26px; text-align:center}
    .action .material-icons{font-size:50px; color:var(--primary); opacity:.95}
    .action .title{margin-top:10px; font-weight:800; font-size:1.5rem}

    .small-actions .card .card-content{padding:16px; text-align:center}

    @media(max-width:992px){
      .app{grid-template-columns:1fr}
      .aside{display:none}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ===== Aside / Menu ===== -->
    <aside class="aside">
      <div class="logo">
        <div class="tick"><i class="material-icons" style="font-size:18px">check</i></div>
        <div style="font-weight:800">Redação Online</div>
      </div>
      <nav class="menu">
        <a class="active" href="#"><i class="material-icons">dashboard</i>Dashboard</a>
        <a href="envio.html"><i class="material-icons">description</i>Envio de Redações</a>
        <a href="professores.html"><i class="material-icons">group</i>Professores</a>
        <a href="relatorios.html"><i class="material-icons">insert_chart_outlined</i>Relatórios</a>
        <a href="config.html"><i class="material-icons">settings</i>Configurações</a>
      </nav>
    </aside>

    <!-- ===== Main ===== -->
    <section class="main">
      <!-- Header -->
      <div class="topbar">
        <div class="wrap">
          <div class="row valign-wrapper" style="margin-bottom:0">
            <div class="col s12 m6 left-align">
              <span class="brand">Redação Online</span>
              <span class="unit">• <span id="unitIdName">—</span></span>
            </div>
            <div class="col s12 m6 right-align">
              <span class="user-chip"><i class="material-icons left">account_circle</i><span id="userName">Usuário</span></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="content">
        <!-- Seletor de Simulado -->
        <div class="row selector-row">
          <div class="col s12 m6 l4">
            <label for="simuladoSelect" class="grey-text text-darken-1" style="font-weight:600">Simulado ENEM</label>
            <select id="simuladoSelect" class="browser-default" style="border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#fff">
              <option value="">Selecione...</option>
              <!-- preenchido via JS -->
            </select>
          </div>
        </div>

        <!-- KPIs -->
        <div class="row" style="margin-bottom:10px">
          <div class="col s12 m4">
            <div class="card edge kpi z-depth-0">
              <div class="card-content center">
                <div class="value" id="kpiInscritos">—</div>
                <div class="label">Inscritos</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge kpi z-depth-0">
              <div class="card-content center">
                <div class="value" id="kpiEnviadas">—</div>
                <div class="label">Redações enviadas</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge kpi z-depth-0">
              <div class="card-content center">
                <div class="value" id="kpiCorretores">—</div>
                <div class="label">Corretores</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações (3 médios: Enviar, Corretores, Conferir envio) -->
        <div class="row">
          <div class="col s12 m4">
            <div class="card edge action hoverable">
              <div class="card-content">
                <i class="material-icons">cloud_upload</i>
                <div class="title">Enviar redação</div>
                <p class="grey-text">Imagens ou PDF • Lote permitido</p>
              </div>
              <div class="card-action center">
                <a href="envio.html" class="btn waves-effect waves-light blue darken-2"><i class="material-icons left">arrow_forward</i>Abrir envio</a>
              </div>
            </div>
          </div>

          <div class="col s12 m4">
            <div class="card edge action hoverable">
              <div class="card-content">
                <i class="material-icons">face</i>
                <div class="title">Corretores</div>
                <p class="grey-text">Gerencie professores da unidade</p>
              </div>
              <div class="card-action center">
                <a href="professores.html" class="btn-flat">Abrir</a>
              </div>
            </div>
          </div>

          <div class="col s12 m4">
            <div class="card edge action hoverable">
              <div class="card-content">
                <i class="material-icons">search</i>
                <div class="title">Conferir envio</div>
                <p class="grey-text">Validar inscrição manualmente (falhas de OMR)</p>
              </div>
              <div class="card-action center">
                <a href="conferir-envio.html" class="btn-flat">Abrir</a>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações menores (opcionais) -->
        <div class="row small-actions">
          <div class="col s12 m4">
            <div class="card edge z-depth-0 hoverable">
              <div class="card-content">
                <i class="material-icons">east</i>
                <div style="font-weight:700">Enviar redação</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge z-depth-0 hoverable">
              <div class="card-content">
                <i class="material-icons">badge</i>
                <div style="font-weight:700">Cadastrar professor</div>
              </div>
            </div>
          </div>
          <div class="col s12 m4">
            <div class="card edge z-depth-0 hoverable">
              <div class="card-content">
                <i class="material-icons">settings</i>
                <div style="font-weight:700">Configurar unidade</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

<script>
/* ===== CONFIG ===== */
const API = 'https://api.secauxiliar.com.br';
const LOGIN_URL = '/redacaoeenem/login.html'; // ajuste se necessário
const SESS_KEY = 'sessao_redacao';

/* ===== Utils de sessão ===== */
function getSession(){
  try { return JSON.parse(localStorage.getItem(SESS_KEY) || '{}'); }
  catch(e){ return {}; }
}
function setSession(sess){
  localStorage.setItem(SESS_KEY, JSON.stringify(sess || {}));
}
function getToken(){
  const sess = getSession();
  // compat: aceita token direto no localStorage também
  return (sess && sess.token) || localStorage.getItem('token') || '';
}
function authHeaders(){
  const t = getToken();
  return t ? { 'Authorization': `Bearer ${t}` } : {};
}
function redirectToLogin(){
  const next = encodeURIComponent(location.pathname + location.search + location.hash);
  location.replace(`${LOGIN_URL}?next=${next}`);
}

/* ===== Helpers de API (com fallback .php) ===== */
async function apiFetch(pathNoPhp, { method='GET', headers={}, body, cache='no-store' } = {}){
  const baseHeaders = { 'Accept': 'application/json', ...authHeaders(), ...headers };
  const opts = { method, cache, headers: baseHeaders, body };

  // 1ª tentativa: rota sem .php
  let res;
  try { res = await fetch(`${API}${pathNoPhp}`, opts); }
  catch(e){ res = null; }

  // se a 1ª falhar por 404/erro de rede, tenta com .php (ex.: /me -> /me.php)
  if (!res || res.status === 404) {
    const phpPath = pathNoPhp.replace(/\/?$/, '').endsWith('.php')
      ? pathNoPhp
      : pathNoPhp.replace(/\/([^\/?#]+)$/, '/$1.php'); // /me -> /me.php ; /dashboard/123 -> /dashboard.php?simulado=123 (tratamos abaixo)
  }

  // Tratamento especial para dashboard com id no path
  if (pathNoPhp.startsWith('/dashboard/')) {
    const simId = decodeURIComponent(pathNoPhp.split('/').pop() || '');
    return apiFetch(`/dashboard.php?simulado=${encodeURIComponent(simId)}`, { method, headers, body, cache });
  }

  if (!res || res.status === 404) {
    const withPhp = pathNoPhp.endsWith('.php') ? pathNoPhp : pathNoPhp + '.php';
    try { res = await fetch(`${API}${withPhp}`, opts); }
    catch(e){ /* fica como null */ }
  }

  if (!res) throw new Error('NETWORK_FAIL');

  if (res.status === 401 || res.status === 403) throw new Error('UNAUTHORIZED');

  if (!res.ok) {
    const txt = await res.text().catch(()=> '');
    throw new Error(`API_${res.status}: ${txt || res.statusText}`);
  }

  return res.json();
}

/* ===== UI helpers ===== */
function setUnitHeader({ codigo, nome } = {}){
  const el = document.getElementById('unitIdName');
  if(!el) return;
  if(codigo && nome) el.textContent = `${codigo} - ${nome}`;
  else if(nome)      el.textContent = nome;
  else               el.textContent = '—';
}
function setUserName(nome){
  const el = document.getElementById('userName');
  if (el && nome) el.textContent = nome;
}

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', initPainel);

async function initPainel(){
  try{
    // guarda dura: sem token não entra
    if (!getToken()) return redirectToLogin();

    // tenta usar sessão do login; se faltar, consulta /me(.php)
    const sess = getSession();
    if (sess?.unidade?.codigo && sess?.unidade?.nome) {
      setUnitHeader(sess.unidade);
      setUserName(sess?.usuario?.nome);
    } else {
      await carregarContextoDaAPI();
    }

    await carregarSimulados();
    document.body.classList.add('ready'); // libere os botões quando estiver pronto
  } catch(err){
    console.error('Falha na inicialização:', err);
    if (String(err.message).includes('UNAUTHORIZED')) return redirectToLogin();
    const statusEl = document.getElementById('statusPainel');
    if (statusEl) statusEl.textContent = 'Não foi possível carregar seus dados. Tente novamente.';
  }
}

/* ===== Contexto (/me) ===== */
async function carregarContextoDaAPI(){
  try{
    const data = await apiFetch('/me'); // tenta /me e /me.php
    // esperado: { usuario:{nome}, unidade:{codigo,nome}, token? }
    if (data?.usuario?.nome) setUserName(data.usuario.nome);
    if (data?.unidade) setUnitHeader(data.unidade);

    // persiste unindo com sessão existente
    const merged = { ...getSession(), ...data };
    setSession(merged);
  }catch(e){
    console.warn('Falha ao carregar contexto da API', e);
    if (String(e.message).includes('UNAUTHORIZED')) redirectToLogin();
  }
}

/* ===== Simulados ===== */
async function carregarSimulados(){
  try{
    // tenta /simulados e depois /simulados.php
    const data = await apiFetch('/simulados');
    const lista = data?.simulados || data || [];
    const sel = document.getElementById('simuladoSelect');
    if (!sel) return;

    // limpa e preenche
    sel.innerHTML = '<option value="" disabled selected>Selecione...</option>';
    (lista || []).forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id || s.codigo;
      opt.textContent = s.nome || s.titulo;
      sel.appendChild(opt);
    });

    if ((lista || []).length === 1){
      sel.value = (lista[0].id || lista[0].codigo);
      onChangeSimulado();
    }
    // reinit Materialize
    if (window.M && M.FormSelect) M.FormSelect.init(sel);
    sel.addEventListener('change', onChangeSimulado);
  }catch(err){
    console.error('Falha ao carregar simulados', err);
    if (String(err.message).includes('UNAUTHORIZED')) redirectToLogin();
  }
}

async function onChangeSimulado(){
  const simId = document.getElementById('simuladoSelect')?.value;
  if(!simId){ setKPIs({}); return; }
  await carregarKPIs(simId);
}

/* ===== KPIs ===== */
async function carregarKPIs(simuladoId){
  try{
    // 1ª tentativa: /dashboard/{id}
    let data;
    try {
      data = await apiFetch(`/dashboard/${encodeURIComponent(simuladoId)}`);
    } catch (e) {
      // fallback: /dashboard.php?simulado=...
      data = await apiFetch(`/dashboard.php?simulado=${encodeURIComponent(simuladoId)}`);
    }
    // esperado: { ok:true, inscritos, enviadas, corretores, unidade:{...}, usuario:{...} }
    setKPIs(data);
  }catch(err){
    console.error('Falha KPIs', err);
    if (String(err.message).includes('UNAUTHORIZED')) redirectToLogin();
  }
}

function setKPIs({ inscritos='—', enviadas='—', corretores='—', unidade, usuario } = {}){
  const elIns = document.getElementById('kpiInscritos');
  const elEnv = document.getElementById('kpiEnviadas');
  const elCor = document.getElementById('kpiCorretores');
  if (elIns) elIns.textContent = inscritos;
  if (elEnv) elEnv.textContent = enviadas;
  if (elCor) elCor.textContent = corretores;

  if (unidade?.codigo && unidade?.nome) setUnitHeader(unidade);
  if (usuario?.nome) setUserName(usuario.nome);
}

/* ===== Opcional: bloquear cliques até ready ===== */
document.addEventListener('click', (ev) => {
  if (!document.body.classList.contains('ready')) {
    const target = ev.target.closest('a,button');
    if (target) {
      ev.preventDefault();
      ev.stopPropagation();
    }
  }
});
</script>
  


</body>
</html>
