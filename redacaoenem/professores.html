<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Professores ‚Ä¢ Reda√ß√£o Online</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3; --ink:#0f172a; --muted:#6b7280; --primary:#0b3b78; --accent:#2563eb;
      --aside-w: 260px;       /* largura do menu lateral */
      --topbar-h: 64px;       /* altura do topo */
    }

    html,body{height:100%}
    body{background:var(--bg); color:var(--ink)}

    /* ===== Layout ===== */
    .app{ display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh; }

    /* üîí Topo azul: full-width, fixo e alinhado ao lado do menu */
    header.topbar{
      position: fixed; top: 0; left: 0; right: 0; height: var(--topbar-h); z-index: 20;
      background: var(--primary); color:#fff; display:flex; align-items:center;
      padding: 12px 24px; padding-left: calc(var(--aside-w) + 24px); box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    header.topbar > .topbar{ background: transparent !important; box-shadow: none !important; }
    header.topbar .container{ max-width: none; width: 100%; margin: 0; padding: 0; }
    header.topbar h5{ margin: 0; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* üîí Sidebar fixa/rol√°vel abaixo do topo */
    aside{
      background:#fff; border-right:1px solid var(--line); position: sticky; top: var(--topbar-h);
      height: calc(100vh - var(--topbar-h)); overflow: auto; align-self: start; z-index: 6;
    }

    /* Conte√∫do principal (empurrado abaixo do topo fixo) */
    main{ display:flex; flex-direction:column; padding-top: calc(var(--topbar-h) + 40px); }

    /* utilit√°rios/estilo */
    .page{padding:24px}
    .muted{color:var(--muted)}
    .card{border-radius:14px; box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .card-title{font-weight:600}
    .table-wrapper{overflow:auto; border:1px solid var(--line); border-radius:10px; background:#fff}
    table.striped>tbody>tr:nth-child(odd){background:#fafbff}
    th{white-space:nowrap}
    td{vertical-align:middle}

    .chip-status{border-radius:999px; padding:2px 10px; font-weight:600; font-size:12px; display:inline-block}
    .ok{background:#e7f8ef; color:#127c46}
    .err{background:#fdecec; color:#b42318}
    .pend{background:#fff7e6; color:#b54708}

    .search-row{display:grid; grid-template-columns: 1fr 160px 140px; gap:12px}

    @media (max-width: 992px){
      .app{ grid-template-columns: 1fr; }
      header.topbar{ padding-left: 16px; }
      .search-row{ grid-template-columns: 1fr; }
    }

    /* menu lateral */
    .menu{list-style:none; padding:0; margin:0}
    .menu a{display:block; padding:12px 16px; color:#111827}
    .menu a:hover{background:#f4f6fb}
    .menu .active>a{background:#eef3ff; font-weight:600}
    .menu .icon{font-size:20px; vertical-align:middle; margin-right:8px; color:#64748b}

    .manual-link{ color:#b54708; font-weight:600; cursor:pointer; text-decoration:underline; }
    .crop-wrap{ width:100%; max-height:60vh; overflow:auto; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px }
    #cropImg{ max-width:100%; display:block; }

    /* respiro visual extra para os cart√µes */
    .content{ margin-top:16px; }
  </style>
</head>
<body>
  <div class="app">
    <!-- ===== Sidebar ===== -->
    <aside>
      <div class="center" style="padding:18px 0 8px">
        <span class="title" style="font-weight:700;color:#0b3b78">Reda√ß√£o Online</span>
      </div>
      <ul class="menu">
        <li><a href="/redacaoenem/painel.html"><span class="icon material-icons">dashboard</span>Dashboard</a></li>
        <li><a href="/redacaoenem/envio.html"><span class="icon material-icons">cloud_upload</span>Envio de Reda√ß√µes</a></li>
        <li class="active"><a href="/redacaoenem/professores.html"><span class="icon material-icons">group</span>Professores</a></li>
        <li><a href="/redacaoenem/relatorios.html"><span class="icon material-icons">bar_chart</span>Relat√≥rios</a></li>
        <li><a href="/redacaoenem/config.html"><span class="icon material-icons">settings</span>Configura√ß√µes</a></li>
      </ul>
    </aside>

    <!-- Main -->
    <section class="main">
      <!-- Header -->
      <header class="topbar">
        <div class="topbar blue darken-3 white-text">
          <div class="container">
            <h5 class="m-0">
              Reda√ß√£o Online ‚Äì <span id="unitLabel">‚Äî</span>
            </h5>
          </div>
        </div>
      </header>

      <!-- Content -->
      <div class="content">
        <div class="row">
          <!-- Formul√°rio -->
          <div class="col s12 m5">
            <div class="card edge z-depth-0">
              <div class="card-content">
                <span class="card-title" style="font-weight:800">Cadastrar professor</span>
                <div class="row" style="margin-bottom:0">
                  <div class="input-field col s12">
                    <input id="nome" type="text" required>
                    <label for="nome">Nome</label>
                  </div>
                  <div class="input-field col s12">
                    <input id="email" type="email" required>
                    <label for="email">E-mail</label>
                  </div>
                  <div class="input-field col s12">
                    <input id="login" type="text" required>
                    <label for="login">Login</label>
                  </div>
                  <div class="col s12" style="margin:6px 0 12px">
                    <label>
                      <input type="checkbox" id="ativo" checked />
                      <span>Ativo</span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="card-action actions">
                <a class="btn blue waves-effect" onclick="salvarCorretor()"><i class="material-icons left">save</i>Salvar</a>
                <a class="btn-flat waves-effect" onclick="limparForm()"><i class="material-icons left">refresh</i>Limpar</a>
              </div>
            </div>
          </div>

          <!-- Lista -->
          <div class="col s12 m7">
            <div class="card edge z-depth-0">
              <div class="card-content">
                <div class="row valign-wrapper" style="margin-bottom:10px">
                  <div class="col s12 m7">
                    <span class="card-title" style="font-weight:800">Corretores</span>
                  </div>
                  <div class="col s12 m5">
                    <div class="input-field" style="margin:0">
                      <i class="material-icons prefix">search</i>
                      <input id="busca" type="text" oninput="carregarLista()" placeholder="Buscar por nome, e-mail ou login">
                    </div>
                  </div>
                </div>
                <table class="striped responsive-table">
                  <thead>
                    <tr>
                      <th>Nome</th>
                      <th>E-mail</th>
                      <th>Login</th>
                      <th style="width:90px">Ativo</th>
                      <th class="right-align" style="width:220px">A√ß√µes</th>
                    </tr>
                  </thead>
                  <tbody id="tbCorretores">
                    <tr><td colspan="5" class="center-align grey-text">Carregando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>
  </div>

<script>
/* ===== CONFIG/API ===== */
const API = 'https://api.secauxiliar.com.br/';
const LOGIN_URL = '/redacaoeenem/login.html'; // manter conforme sua estrutura atual
const SESS_KEY = 'sessao_redacao';

/* Sess√£o */
function getSession(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)||'{}'); }catch(e){ return {}; } }
function setSession(s){ localStorage.setItem(SESS_KEY, JSON.stringify(s||{})); }
function getToken(){ const s=getSession(); return (s&&s.token) || localStorage.getItem('token') || ''; }
function authHeaders(){ const t=getToken(); return t?{'Authorization':'Bearer '+t}:{ }; }
function redirectToLogin(){ const next=encodeURIComponent(location.pathname+location.search+location.hash); location.replace(`${LOGIN_URL}?next=${next}`); }

/* Fetch helper com fallback .php */
async function apiFetch(pathNoPhp, { method='GET', headers={}, body, cache='no-store' } = {}){
  const baseHeaders = { Accept: 'application/json', ...authHeaders(), ...headers };
  if (body) baseHeaders['Content-Type'] = 'application/json'; // s√≥ quando precisa
  const opts = { method, cache, headers: baseHeaders, body };

  let res;
  try { res = await fetch(`${API}${pathNoPhp}`, opts); } catch(e){ res = null; }
  if (!res || res.status === 404) {
    const withPhp = pathNoPhp.endsWith('.php') ? pathNoPhp : pathNoPhp + '.php';
    try { res = await fetch(`${API}${withPhp}`, opts); } catch(e){}
  }
  if (!res) throw new Error('NETWORK_FAIL');
  if (res.status === 401 || res.status === 403) throw new Error('UNAUTHORIZED');
  if (!res.ok) {
    const txt = await res.text().catch(()=> '');
    throw new Error(`API_${res.status}: ${txt || res.statusText}`);
  }
  return res.json();
}

/* UI helpers */
function setUnitHeader({ codigo, nome } = {}){
  const el=document.getElementById('unitLabel');
  if(!el) return;
  if(codigo && nome) el.textContent = `${codigo} - ${nome}`;
  else if(nome) el.textContent = nome; else el.textContent = '‚Äî';
}
function setUserName(n){ const el=document.getElementById('userName'); if(el&&n) el.textContent=n; }
function toast(msg){ M && M.toast ? M.toast({html: msg}) : alert(msg); }

/* Boot */
document.addEventListener('DOMContentLoaded', async () => {
  try{
    if (!getToken()) return redirectToLogin();
    await carregarContexto();   // preenche topo e guarda unidade
    limparForm();
    await carregarLista();
  }catch(e){
    if (String(e.message).includes('UNAUTHORIZED')) return redirectToLogin();
    console.error(e);
  }
});

/* Contexto /auth_me.php */
async function carregarContexto(){
  const data = await apiFetch('/auth_me.php');
  // fallback se backend retornar {user:{...}}
  if (data?.user && !data?.usuario && !data?.unidade) {
    const u=data.user;
    data.usuario={nome:u.nome||u.login||'Usu√°rio'};
    data.unidade={codigo:u.login||'', nome:u.unidade||''};
  }
  if (data?.usuario?.nome) setUserName(data.usuario.nome);
  if (data?.unidade) setUnitHeader(data.unidade);

  // guarda tudo e mant√©m uma c√≥pia r√°pida da unidade
  setSession({ ...getSession(), ...data });
  window.UNIT = data.unidade || {};
}

function unidadeAtual(){
  return (window.UNIT && window.UNIT.codigo) || (getSession().unidade||{}).codigo || '';
}

/* Estado form/lista */
let editId = 0;

function limparForm(){
  editId = 0;
  document.getElementById('nome').value='';
  document.getElementById('email').value='';
  document.getElementById('login').value='';
  document.getElementById('ativo').checked=true;
  if (window.M && M.updateTextFields) M.updateTextFields();
}

/* CRUD */
async function carregarLista(){
  const q = document.getElementById('busca').value.trim();
  const u = unidadeAtual();
  let url = '/corretores_list';
  const qp = [];
  if (u) qp.push('unidade='+encodeURIComponent(u));
  if (q) qp.push('q='+encodeURIComponent(q));
  if (qp.length) url += '?' + qp.join('&');

  const data = await apiFetch(url);

  const tb = document.getElementById('tbCorretores');
  tb.innerHTML = '';
  const items = data.items || [];
  if (!items.length){
    tb.innerHTML = '<tr><td colspan="5" class="center-align grey-text">Nenhum professor encontrado.</td></tr>';
    return;
  }

  items.forEach(row=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.nome}</td>
      <td>${row.email}</td>
      <td>${row.login}</td>
      <td>
        <label>
          <input type="checkbox" ${row.ativo?'checked':''} onchange="toggleAtivo(${row.id}, this.checked)">
          <span></span>
        </label>
      </td>
      <td class="right-align right-actions">
        <a class="btn-flat waves-effect" onclick='editar(${JSON.stringify(row).replaceAll("'", "&apos;")})'><i class="material-icons left">edit</i>Editar</a>
        <a class="btn-flat waves-effect" onclick='convidar(${row.id})'><i class="material-icons left">mail_outline</i>Convidar</a>
        <a class="btn-flat red-text waves-effect" onclick='excluir(${row.id})'><i class="material-icons left">delete_outline</i>Excluir</a>
      </td>`;
    tb.appendChild(tr);
  });
}

function editar(row){
  editId = row.id;
  document.getElementById('nome').value = row.nome || '';
  document.getElementById('email').value = row.email || '';
  document.getElementById('login').value = row.login || '';
  document.getElementById('ativo').checked = !!row.ativo;
  if (window.M && M.updateTextFields) M.updateTextFields();
}

async function salvarCorretor(){
  const payload = {
    id: editId,
    nome: document.getElementById('nome').value.trim(),
    email: document.getElementById('email').value.trim(),
    login: document.getElementById('login').value.trim(),
    ativo: document.getElementById('ativo').checked ? 1 : 0,
    unidade: unidadeAtual()
  };
  if (!payload.nome || !payload.email || !payload.login) {
    return toast('Preencha Nome, E-mail e Login');
  }
  await apiFetch('/corretores_save', { method:'POST', body: JSON.stringify(payload) });
  toast(editId ? 'Professor atualizado' : 'Professor cadastrado');
  limparForm();
  carregarLista();
}

async function toggleAtivo(id, ativo){
  await apiFetch('/corretores_toggle', { method:'POST', body: JSON.stringify({id, ativo:ativo?1:0, unidade:unidadeAtual()}) });
  toast(ativo? 'Ativado' : 'Desativado');
}

async function excluir(id){
  if (!confirm('Excluir este professor?')) return;
  await apiFetch('/corretores_delete', { method:'POST', body: JSON.stringify({id, unidade:unidadeAtual()}) });
  toast('Professor exclu√≠do');
  carregarLista();
}

async function convidar(id){
  const ret = await apiFetch('/corretores_convite', { method:'POST', body: JSON.stringify({id, unidade:unidadeAtual()}) });
  toast(ret.sent ? 'Convite enviado por e-mail' : 'Convite gerado');
}
</script>
</body>
</html>
