<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Painel ‚Ä¢ Simulado ENEM - Reda√ß√£o</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3; --ink:#0f172a; --muted:#6b7280; --primary:#0b3b78; --accent:#2563eb;
      --aside-w: 260px;       /* largura do menu lateral */
      --topbar-h: 64px;       /* altura do topo */
    }

    html,body{height:100%}
    body{background:var(--bg); color:var(--ink)}

    /* ===== Layout ===== */
    .app{ display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh; }

    /* üîí Topo azul: full-width, fixo e alinhado ao lado do menu */
    header.topbar{
      position: fixed; top: 0; left: 0; right: 0; height: var(--topbar-h); z-index: 20;
      background: var(--primary); color:#fff; display:flex; align-items:center;
      padding: 12px 24px; padding-left: 0; box-shadow:0 2px 10px rgba(16,24,40,.12);
      /*calc(var(--aside-w) + 24px)*/
    }
    header.topbar > .topbar{ background: transparent !important; box-shadow: none !important; }
    header.topbar .container{ max-width: none; width: 100%; margin: 0; padding: 0; }
    header.topbar h5{ margin: 0; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* üîí Sidebar fixa/rol√°vel abaixo do topo */
    aside{
      background:#fff; border-right:1px solid var(--line); position: sticky; top: var(--topbar-h);
      height: calc(100vh - var(--topbar-h)); overflow: auto; align-self: start; z-index: 6;
    }

    /* Conte√∫do principal (empurrado abaixo do topo fixo) */
    main{ display:flex; flex-direction:column; padding-top: calc(var(--topbar-h) + 8px); }

    /* utilit√°rios/estilo */
    .page{padding:24px}
    .muted{color:var(--muted)}
    .card{border-radius:14px; box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .card-title{font-weight:600}
    .table-wrapper{overflow:auto; border:1px solid var(--line); border-radius:10px; background:#fff}
    table.striped>tbody>tr:nth-child(odd){background:#fafbff}
    th{white-space:nowrap}
    td{vertical-align:middle}

    .chip-status{border-radius:999px; padding:2px 10px; font-weight:600; font-size:12px; display:inline-block}
    .ok{background:#e7f8ef; color:#127c46}
    .err{background:#fdecec; color:#b42318}
    .pend{background:#fff7e6; color:#b54708}

    .search-row{display:grid; grid-template-columns: 1fr 160px 140px; gap:12px}

    @media (max-width: 992px){
      .app{ grid-template-columns: 1fr; }
      header.topbar{ padding-left: 16px; }
      .search-row{ grid-template-columns: 1fr; }
    }

    /* menu lateral */
    .menu{list-style:none; padding:0; margin:0}
    .menu a{display:block; padding:12px 16px; color:#111827}
    .menu a:hover{background:#f4f6fb}
    .menu .active>a{background:#eef3ff; font-weight:600}
    .menu .icon{font-size:20px; vertical-align:middle; margin-right:8px; color:#64748b}
  </style>
</head>

<body>
<div class="app">
  <!-- ===== Sidebar (igual ao envio.html) ===== -->
  <aside>
    <div class="center" style="padding:18px 0 8px">
      <span class="title" style="font-weight:700;color:#0b3b78">Reda√ß√£o</span>
    </div>
    <ul class="menu">
      <li class="active"><a href="/redacaoenem/painel.html"><span class="icon material-icons">dashboard</span>Dashboard</a></li>
      <li><a href="/redacaoenem/envio.html"><span class="icon material-icons">cloud_upload</span>Envio de Reda√ß√µes</a></li>
      <li><a href="/redacaoenem/professores.html"><span class="icon material-icons">group</span>Professores</a></li>
      <li><a href="/redacaoenem/relatorios.html"><span class="icon material-icons">bar_chart</span>Relat√≥rios</a></li>
      <!-- <li><a href="/redacaoenem/config.html"><span class="icon material-icons">settings</span>Configura√ß√µes</a></li> -->
    </ul>
  </aside>

  <main>
    <header class="topbar">
      <div class="topbar blue darken-3 white-text"
          style="display:flex; align-items:center; justify-content:space-between; padding:0 24px; width:100%;">
        
        <!-- Bloco ESQUERDA -->
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/redacaoenem/logo-mini.png" alt="Logo" style="height:28px; width:auto; margin-left:8px;">
          <h5 class="m-0" style="margin:0; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
            Simulado Aberto ENEM - Reda√ß√£o ‚Äì <span id="unitLabel">‚Äî</span>
          </h5>
        </div>

        <!-- Bloco DIREITA -->
        <div style="display:flex; gap:8px; align-items:center">
          <a id="btnLogout" class="btn-flat waves-effect white-text" href="#!" onclick="logout()">
            <i class="material-icons left">exit_to_app</i>Sair
          </a>
        </div>
      </div>
    </header>

    <section class="page" style="padding:24px">
      <div class="card">
        <div class="card-content">
          <span class="card-title">Reda√ß√µes e corre√ß√µes</span>

          <div class="row" style="margin-top:8px">
            <div class="input-field col s12 m6">
              <i class="material-icons prefix">search</i>
              <input id="q" type="text" placeholder="Buscar inscri√ß√£o ou nome do arquivo‚Ä¶">
            </div>
            <div class="col s12 m6 right-align" style="align-self:center">
              <a id="btnRefresh" class="btn waves-effect"><i class="material-icons left">refresh</i>Atualizar</a>
              <a id="btnCsv" class="btn blue darken-2 waves-effect"><i class="material-icons left">file_download</i>CSV</a>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="striped highlight responsive-table">
              <thead>
                <tr>
                  <th>Inscri√ß√£o</th>
                  <th>Nome recebido</th>
                  <th>Nome final</th>
                  <th>OMR_STATUS</th>
                  <th class="center">C1</th>
                  <th class="center">C2</th>
                  <th class="center">C3</th>
                  <th class="center">C4</th>
                  <th class="center">C5</th>
                  <th class="center">Total</th>
                  <th>Corretor</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="row" style="margin-top:8px">
            <div class="col s12 m6"><span id="totalInfo" class="grey-text"></span></div>
            <div class="col s12 m6 right-align">
              <a id="prev" class="btn-flat"><i class="material-icons left">chevron_left</i>Anterior</a>
              <a id="next" class="btn-flat">Pr√≥xima<i class="material-icons right">chevron_right</i></a>
            </div>
          </div>

          <div class="divider" style="margin:12px 0"></div>

          <h6 style="font-weight:600">Total de corre√ß√µes por corretor</h6>
          <div class="table-wrapper">
            <table class="striped">
              <thead><tr><th>Corretor</th><th class="right">Total</th></tr></thead>
              <tbody id="tbodyAgg"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
/* Helpers j√° usados no projeto */
const API_BASE = 'https://api.secauxiliar.com.br/';
const LOGIN_URL = '/redacaoenem/index.html';
const SESS_KEY = 'sessao_redacao';
function getSession(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY)||'{}'); }catch(_){ return {}; } }
function getToken(){ const s=getSession(); return (s&&s.token) || localStorage.getItem('token') || ''; }
function authHeaders(){ const t=getToken(); return t ? { Authorization:'Bearer '+t } : {}; }
function redirectToLogin(){ const next = encodeURIComponent(location.pathname+location.search+location.hash); location.replace(`${LOGIN_URL}?next=${next}`); }
async function apiFetch(path, { method='POST', headers={}, body } = {}){
  const h = { Accept:'application/json', 'Content-Type':'application/json', ...authHeaders(), ...headers };
  const res = await fetch(API_BASE + path.replace(/^\//,''), { method, headers:h, body });
  if (res.status===401 || res.status===403) throw new Error('UNAUTHORIZED');
  if (!res.ok) throw new Error('API_'+res.status);
  return res.json();
}
function setUnitHeader(u){ const el=document.getElementById('unitLabel'); if (!el) return; el.textContent = (u?.codigo && u?.nome) ? `${u.codigo} - ${u.nome}` : (u?.nome || '‚Äî'); }

/* Tabela */
let PAGE=1, SIZE=25, TOTAL=0, LAST=[];
const tbody = document.getElementById('tbody');
const tbodyAgg = document.getElementById('tbodyAgg');
const info  = document.getElementById('totalInfo');

function renderRows(items){
  LAST = items||[];
  tbody.innerHTML = (items||[]).map(r => `
    <tr>
      <td>${r.inscricao ?? ''}</td>
      <td title="${r.nome_recebido ?? ''}">${r.nome_recebido ?? ''}</td>
      <td title="${r.nome_final ?? ''}">${r.nome_final ?? ''}</td>
      <td>${r.omr_status ?? ''}</td>
      <td class="center">${r.c1 ?? ''}</td>
      <td class="center">${r.c2 ?? ''}</td>
      <td class="center">${r.c3 ?? ''}</td>
      <td class="center">${r.c4 ?? ''}</td>
      <td class="center">${r.c5 ?? ''}</td>
      <td class="center"><b>${r.total ?? ''}</b></td>
      <td>${r.corretor ?? '‚Äî'}</td>
    </tr>
  `).join('');
}

function renderAgg(list){
  tbodyAgg.innerHTML = (list||[]).map(a => `
    <tr>
      <td>${a.corretor ?? '‚Äî'}</td>
      <td class="right"><b>${a.total ?? 0}</b></td>
    </tr>
  `).join('');
}

async function load(){
  const q = (document.getElementById('q').value||'').trim();
  const sess = getSession();
  const codUnd = sess?.unidade?.codigo || '';
  if (!codUnd) return redirectToLogin();

  const res = await apiFetch('/relatorio_list.php', {
    body: JSON.stringify({ codUnd, q, page: PAGE, pageSize: SIZE })
  });

  const items = res?.data?.items || [];
  const agg   = res?.data?.por_corretor || [];
  TOTAL = Number(res?.data?.total || items.length) || 0;

  renderRows(items);
  renderAgg(agg);
  info.textContent = TOTAL ? `P√°gina ${PAGE} ‚Ä¢ ${items.length} itens ‚Ä¢ Total: ${TOTAL}` : 'Nenhum registro.';
}

/* CSV r√°pido */
function toCsv(v){ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[;"\n]/.test(s)?`"${s}"`:s; }

function csvNum(v){
    if (v == null) return '';
    const s = String(v).replace(/"/g, '""');
    return /[;"\n]/.test(s) ? `"${s}"` : s;
  }

  /* for√ßa c√©lula como TEXTO no Excel (evita perder zeros) */
  function csvText(v){
    const s = (v == null ? '' : String(v).replace(/"/g, '""'));
    return `="${s}"`;
  }

  function downloadCsv(){
    const hdr = [
      'INSCRICAO','NOME_ARQUIVO_RECEBIDO','NOME_ARQUIVO_FINAL',
      'OMR_STATUS','C1','C2','C3','C4','C5','TOTAL','CORRETOR'
    ];
    const lines = [hdr.join(';')];

    LAST.forEach(r => {
      lines.push([
        csvText(r.inscricao),               // <<--- aqui for√ßa texto
        csvNum(r.nome_recebido),
        csvNum(r.nome_final),
        csvNum(r.omr_status),
        csvNum(r.c1), csvNum(r.c2), csvNum(r.c3), csvNum(r.c4), csvNum(r.c5),
        csvNum(r.total),
        csvNum(r.corretor)
      ].join(';'));
    });

    const blob = new Blob(["\uFEFF" + lines.join('\n')], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'relatorio_redacoes.csv';
    a.click();
    URL.revokeObjectURL(a.href);
  }

/* Boot */
document.addEventListener('DOMContentLoaded', ()=>{
  if (!getToken()) return redirectToLogin();
  // header da unidade (se j√° estiver na sess√£o)
  const sess = getSession(); if (sess?.unidade) setUnitHeader(sess.unidade);

  document.getElementById('btnRefresh').addEventListener('click', load);
  document.getElementById('btnCsv').addEventListener('click', downloadCsv);
  document.getElementById('prev').addEventListener('click', ()=>{ if(PAGE>1){ PAGE--; load(); }});
  document.getElementById('next').addEventListener('click', ()=>{ PAGE++; load(); });
  document.getElementById('q').addEventListener('input', ()=>{ PAGE=1; /* debounce simples */ clearTimeout(window._t); window._t=setTimeout(load,300); });

  load();
});

function wipeSession(){
  try {
    localStorage.removeItem(SESS_KEY);
    localStorage.removeItem('token');        // compat
    // limpa caches do navegador (se houver)
    if (window.caches && caches.keys) {
      caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }
  } catch(_) {}
}

function logout(){
  wipeSession();
  // volta para a tela de login
  location.replace('/redacaoenem/index.html');
}

</script>
</body>
</html>
