<!DOCTYPE html>
<!-- Sistema de envio de arquivos - reda√ß√£o - simulado enem - Adilson Alves -->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Enviar Reda√ß√£o ‚Ä¢ Reda√ß√£o Online</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3; --ink:#0f172a; --muted:#6b7280; --primary:#0b3b78; --accent:#2563eb;
      --aside-w: 260px;       /* largura do menu lateral */
      --topbar-h: 64px;       /* altura do topo */
    }

    html,body{height:100%}
    body{background:var(--bg); color:var(--ink)}

    /* ===== Layout ===== */
    .app{ display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh; }

    /* üîí Topo azul: full-width, fixo e alinhado ao lado do menu */
    header.topbar{
      position: fixed; top: 0; left: 0; right: 0; height: var(--topbar-h); z-index: 20;
      background: var(--primary); color:#fff; display:flex; align-items:center;
      padding: 12px 24px; padding-left: 0; box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    header.topbar > .topbar{ background: transparent !important; box-shadow: none !important; }
    header.topbar .container{ max-width: none; width: 100%; margin: 0; padding: 0; }
    header.topbar h5{ margin: 0; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* üîí Sidebar fixa/rol√°vel abaixo do topo */
    aside{
      background:#fff; border-right:1px solid var(--line); position: sticky; top: var(--topbar-h);
      height: calc(100vh - var(--topbar-h)); overflow: auto; align-self: start; z-index: 6;
    }

    /* Conte√∫do principal (empurrado abaixo do topo fixo) */
    main{ display:flex; flex-direction:column; padding-top: calc(var(--topbar-h) + 8px); }

    /* utilit√°rios/estilo */
    .page{padding:24px}
    .muted{color:var(--muted)}
    .card{border-radius:14px; box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .card-title{font-weight:600}
    .table-wrapper{overflow:auto; border:1px solid var(--line); border-radius:10px; background:#fff}
    table.striped>tbody>tr:nth-child(odd){background:#fafbff}
    th{white-space:nowrap}
    td{vertical-align:middle}

    .chip-status{border-radius:999px; padding:2px 10px; font-weight:600; font-size:12px; display:inline-block}
    .ok{background:#e7f8ef; color:#127c46}
    .err{background:#fdecec; color:#b42318}
    .pend{background:#fff7e6; color:#b54708}

    .search-row{display:grid; grid-template-columns: 1fr 160px 140px; gap:12px}

    @media (max-width: 992px){
      .app{ grid-template-columns: 1fr; }
      header.topbar{ padding-left: 16px; }
      .search-row{ grid-template-columns: 1fr; }
    }

    /* menu lateral */
    .menu{list-style:none; padding:0; margin:0}
    .menu a{display:block; padding:12px 16px; color:#111827}
    .menu a:hover{background:#f4f6fb}
    .menu .active>a{background:#eef3ff; font-weight:600}
    .menu .icon{font-size:20px; vertical-align:middle; margin-right:8px; color:#64748b}

    .manual-link{ color:#b54708; font-weight:600; cursor:pointer; text-decoration:underline; }
    .crop-wrap{ width:100%; max-height:60vh; overflow:auto; background:#f8fafc; border:1px solid #e5e7eb; border-radius:10px }
    #cropImg{ max-width:100%; display:block; }

  </style>

</head>

<body>
<div class="app">
  <!-- ===== Sidebar ===== -->
  <aside>
    <div class="center" style="padding:18px 0 8px">
      <span class="title" style="font-weight:700;color:#0b3b78">Reda√ß√£o</span>
    </div>
    <ul class="menu">
      <li><a href="/redacaoenem/painel.html"><span class="icon material-icons">dashboard</span>Dashboard</a></li>
      <li class="active"><a href="/redacaoenem/envio.html"><span class="icon material-icons">cloud_upload</span>Envio de Reda√ß√µes</a></li>
      <li><a href="/redacaoenem/professores.html"><span class="icon material-icons">group</span>Professores</a></li>
      <li><a href="/redacaoenem/relatorios.html"><span class="icon material-icons">bar_chart</span>Relat√≥rios</a></li>
      <!-- <li><a href="/redacaoenem/config.html"><span class="icon material-icons">settings</span>Configura√ß√µes</a></li> -->
    </ul>
  </aside>

  <!-- ===== Main ===== -->
  <main>
    <header class="topbar">
      <div class="topbar blue darken-3 white-text"
          style="display:flex; align-items:center; justify-content:space-between; padding:0 24px; width:100%;">
        
        <!-- Bloco ESQUERDA -->
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/redacaoenem/logo-mini.png" alt="Logo" style="height:28px; width:auto; margin-left:8px;">
          <h5 class="m-0" style="margin:0; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">
            Simulado Aberto ENEM - Reda√ß√£o ‚Äì <span id="unitLabel">‚Äî</span>
          </h5>
        </div>

        <!-- Bloco DIREITA -->
        <div style="display:flex; gap:8px; align-items:center">
          <a id="btnLogout" class="btn-flat waves-effect white-text" href="#!" onclick="logout()">
            <i class="material-icons left">exit_to_app</i>Sair
          </a>
        </div>
      </div>
    </header>

    <section class="page">
      <!-- Breadcrumb -->
      <div class="row" style="margin-bottom:0">
        <div class="col s12">
          <a href="/redacaoenem/painel.html" class="breadcrumb">Dashboard</a>
          <a href="#!" class="breadcrumb">Envio de Reda√ß√µes</a>
        </div>
      </div>

      <!-- Card principal -->
      <div class="card">
        <div class="card-content">
          <span class="card-title">Envio de arquivos</span>
          <p class="muted" style="margin-top:6px">
            Selecione imagens (JPG ou JPEG). Cada arquivo ser√° validado na API de resolu√ß√£o.
            Aprovados s√£o enviados ao Drive e salvos no LOG.
          </p>

          <!-- Unidade (oculto se vier do login/sess√£o) -->
          <div class="row" style="margin-top:14px">
            <div class="input-field col s12 m4">
              <input id="codUnd" type="text" placeholder="Ex.: 1501">
              <label for="codUnd" class="active">C√≥digo da Unidade</label>
              <span class="helper-text muted">Se j√° estiver logado por unidade, este campo pode vir preenchido/oculto.</span>
            </div>
          </div>

          <!-- √Årea de sele√ß√£o -->
          <div id="drop" class="card-panel">
            <i class="material-icons" style="font-size:40px">cloud_upload</i>
            <p class="muted" style="margin:6px 0 16px">Arraste e solte aqui, ou</p>
            <input id="files" type="file" multiple
                   accept=".jpg,.jpeg,.png,.pdf,.tif,.tiff,.heic"
                   class="hidden">
            <button id="btnPick" class="btn waves-effect">Selecionar arquivos</button>
          </div>

          <!-- Lista de uploads -->
          <ul id="list" class="collection" style="max-height:360px; overflow:auto"></ul>

          <div class="right-align" style="margin-top:6px">
            <button id="btnSend" class="btn blue darken-2 waves-effect">
              <i class="material-icons left">send</i> Enviar
            </button>
            <a href="/redacaoenem/painel.html" class="btn-flat">Voltar</a>
            <span id="status" class="muted" style="margin-left:12px"></span>
          </div>
        </div>
      </div>

      <!-- Dicas -->
      <div class="card" style="margin-top:14px">
        <div class="card-content">
          <span class="card-title">Como funciona</span>
          <ul class="browser-default">
            <li>O sistema valida resolu√ß√£o (ex.: ‚â•300 dpi). Se reprovado, o arquivo n√£o √© enviado.</li>
            <li>Se aprovado, o arquivo √© salvo no Google Drive e registrado na tabela LOG.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>
</div>

<input type="hidden" name="ts" id="ts">

  

<script>

let queue = []; // {file, li, bar, msg, key, status}
const enviados = new Set();                         // [+] novo
function keyOf(f){ return `${f.name}|${f.size}|${f.lastModified}`; } // [+] novo

function purgeEnviadosDaTela(){                     // [+] novo
  // remove da UI e da fila tudo que j√° est√° com status 'enviado'
  for (const it of queue.filter(x => x.status === 'enviado')){
    it.li?.remove();
  }
  queue = queue.filter(x => x.status !== 'enviado');
}


/* ===================== SESS√ÉO / CONTEXTO (igual ao professores.html) ===================== */
const API_BASE   = 'https://api.secauxiliar.com.br/';
const LOGIN_URL  = '/redacaoenem/index.html';
const SESS_KEY   = 'sessao_redacao';
function novoTimestamp(){
  const d = new Date();
  return d.toTimeString().slice(0,8).replace(/:/g,''); // HHMMSS
}
document.getElementById('ts').value = novoTimestamp(); // inicial

// üîπ Controle do lote atual
let currentBatchId = null;
function startNewBatch(){
  document.getElementById('ts').value = novoTimestamp(); // renova HHMMSS
  currentBatchId = `L${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
}




function getSession(){ try{ return JSON.parse(localStorage.getItem(SESS_KEY) || '{}'); }catch(_){ return {}; } }
function setSession(s){ localStorage.setItem(SESS_KEY, JSON.stringify(s||{})); }
function getToken(){ const s=getSession(); return (s && s.token) || localStorage.getItem('token') || ''; }
function authHeaders(){ const t=getToken(); return t ? { 'Authorization':'Bearer '+t } : {}; }
function redirectToLogin(){
  const next = encodeURIComponent(location.pathname+location.search+location.hash);
  location.replace(`${LOGIN_URL}?next=${next}`);
}

/** fetch com fallback (.php), headers de auth e tratamento de erro */
async function apiFetch(pathNoPhp, { method='GET', headers={}, body, cache='no-store' } = {}){
  const baseHeaders = { Accept:'application/json', ...authHeaders(), ...headers };
  // S√≥ seta Content-Type quando for JSON body
  const opts = { method, cache, headers: baseHeaders, body };
  if (body && typeof body === 'string' && !baseHeaders['Content-Type']) {
    baseHeaders['Content-Type'] = 'application/json';
  }

  let res;
  try { res = await fetch(`${API_BASE}${pathNoPhp}`, opts); } catch(_){ res = null; }
  if (!res || res.status === 404) {
    const withPhp = pathNoPhp.endsWith('.php') ? pathNoPhp : pathNoPhp + '.php';
    try { res = await fetch(`${API_BASE}${withPhp}`, opts); } catch(_){}
  }
  if (!res) throw new Error('NETWORK_FAIL');
  if (res.status === 401 || res.status === 403) throw new Error('UNAUTHORIZED');
  if (!res.ok) {
    const txt = await res.text().catch(()=> '');
    throw new Error(`API_${res.status}: ${txt || res.statusText}`);
  }
  return res.json();
}

function setUnitHeader(unit){
  const el = document.getElementById('unitLabel') || document.getElementById('unitIdName');
  if (!el) return;
  if (unit?.codigo && unit?.nome) el.textContent = `${unit.codigo} - ${unit.nome}`;
  else if (unit?.codigo) el.textContent = unit.codigo;
  else if (unit?.nome) el.textContent = unit.nome;
  else el.textContent = '‚Äî';
}

/** Carrega contexto do usu√°rio/unidade via /auth_me.php (mesma l√≥gica do professores) */
async function carregarContexto(){
  const data = await apiFetch('/auth_me.php');
  // Fallback caso o backend retorne {user:{...}} em vez de {usuario, unidade}
  if (data?.user && !data?.usuario && !data?.unidade) {
    const u = data.user;
    data.usuario = { nome: u.nome || u.login || 'Usu√°rio' };
    data.unidade = { codigo: u.login || '', nome: u.unidade || '' };
  }
  setSession({ ...getSession(), ...data });
  setUnitHeader(data.unidade);

  // Preenche e oculta o input de unidade se veio do login
  const codInput = document.getElementById('codUnd');
  if (codInput && data?.unidade?.codigo) {
    codInput.value = data.unidade.codigo;
    codInput.setAttribute('readonly', 'readonly');
    codInput.closest('.row')?.classList.add('hide'); // opcional: esconder
  }
  return data;
}

/* ===================== UPLOAD (fila, barra e respostas) ===================== */
document.addEventListener('DOMContentLoaded', async () => {
  // Materialize
  window.M && M.AutoInit();

  // exige login
  if (!getToken()) return redirectToLogin();

  // carrega contexto (topo + codUnd)
  try { await carregarContexto(); }
  catch(e){ if (String(e.message).includes('UNAUTHORIZED')) return redirectToLogin(); }

  const API_UPLOAD = 'https://api.secauxiliar.com.br/upload.php'; // endpoint PHP
  const ACCEPT_EXT = ['jpg','jpeg']; // valida√ß√£o extra no front (se quiser permitir mais, ajuste)

  const btnPick  = document.getElementById('btnPick');
  const input    = document.getElementById('files');
  const drop     = document.getElementById('drop');
  const list     = document.getElementById('list');
  const btnSend  = document.getElementById('btnSend');
  const statusEl = document.getElementById('status');
  const codUndEl = document.getElementById('codUnd');

  //let queue = []; // {file, li, bar, msg}

  // ===== BOT√ÉO "Selecionar arquivos":
  btnPick.addEventListener('click', () => {
    purgeEnviadosDaTela();
    startNewBatch();          // üîÑ novo lote
    input.click();
  });

  drop.addEventListener('drop',(e)=>{
    drop.classList.remove('drag');
    startNewBatch();          // üîÑ novo lote
    addFiles(e.dataTransfer.files);
  });

  input.addEventListener('change', () => addFiles(input.files));

  ['dragenter','dragover','dragleave','drop'].forEach(ev => {
    drop.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); });
  });
  drop.addEventListener('dragenter',() => drop.classList.add('drag'));
  drop.addEventListener('dragleave',() => drop.classList.remove('drag'));
  
  function addFiles(fileList){
    purgeEnviadosDaTela();                            // [+] novo: tamb√©m limpa ao trocar sele√ß√£o
    [...fileList].forEach(file => {
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      if (!ACCEPT_EXT.includes(ext)) {
        window.M && M.toast ? M.toast({html:`Tipo n√£o permitido: ${ext}`}) : alert(`Tipo n√£o permitido: ${ext}`);
        return;
      }
      const key = keyOf(file);                        // [+] novo
      if (enviados.has(key)) return;                  // [+] n√£o reexibe o que j√° foi enviado
      if (queue.some(q => q.key === key)) return;     // evita duplicado na fila

      const li = document.createElement('li');
      li.className = 'collection-item';
      li.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px">
          <div style="flex:1">
            <div><strong>${file.name}</strong>
              <span class="grey-text" style="font-size:12px">(${(file.size/1024/1024).toFixed(2)} MB)</span>
            </div>
            <div class="progress" style="margin:8px 0 0">
              <div class="determinate" style="width:0%"></div>
            </div>
            <div class="grey-text" style="font-size:12px" data-msg>aguardando‚Ä¶</div>
          </div>
          <a class="secondary-content" href="#!" data-remove><i class="material-icons">close</i></a>
        </div>`;
      list.appendChild(li);
      const bar = li.querySelector('.determinate');
      const msg = li.querySelector('[data-msg]');
      li.querySelector('[data-remove]').onclick = () => {
        queue = queue.filter(q => q.li !== li);
        li.remove();
        updateSendButton();  
      };
      queue.push({file, li, bar, msg, key, status:'pendente'});  // [+] status + key
    });
    // permite reescolher o mesmo arquivo depois
    input.value = '';                                  // [+] novo
    updateSendButton();
  }

  btnSend.addEventListener('click', async (e) => {
    e.preventDefault();
    const codUnd = (codUndEl.value || '').trim();
    if (!codUnd) { M?.toast ? M.toast({html:'Informe o c√≥digo da unidade'}) : alert('Informe o c√≥digo da unidade'); return; }

    const pendentes = queue.filter(it => it.status === 'pendente');
    if (!pendentes.length){
      M?.toast ? M.toast({html:'Nada a enviar: todos os itens desta lista j√° foram enviados.'}) : alert('Nada a enviar.');
      updateSendButton();
      return;
    }

    btnSend.disabled = true;
    statusEl.textContent = 'Enviando‚Ä¶';

    // (se voc√™ j√° tem batchId, mantenha)
    const batchId = currentBatchId || (currentBatchId = `L${Date.now()}_${Math.random().toString(36).slice(2,8)}`);
    let seq = 1;
    for (const it of pendentes) it._seq = seq++;

    for (const item of pendentes) {
      try { await sendOne(item, codUnd, batchId); } catch(e){ console.error(e); }
    }

    statusEl.textContent = 'Envio conclu√≠do.';
    updateSendButton(); // vai ficar desabilitado se n√£o sobrar pendente
  });


  function sendOne(item, codUnd, batchId){
    return new Promise((resolve) => {
      const xhr = new XMLHttpRequest();
      const form = new FormData();
      form.append('file',   item.file);
      form.append('codUnd', codUnd);

      const ts = document.getElementById('ts').value;   // vem do lote atual
      form.append('ts',      ts);
      form.append('batchId', batchId);                  // üîπ novo
      form.append('seq',     String(item._seq));        // üîπ novo (_1, _2, ...)

      xhr.open('POST', API_UPLOAD, true);

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) item.bar.style.width = ((e.loaded/e.total)*100).toFixed(0) + '%';
      };

      xhr.onreadystatechange = () => {
        if (xhr.readyState !== 4) return;

        let resp = {};
        try { resp = JSON.parse(xhr.responseText || '{}'); } catch(_){}

        if (xhr.status >= 200 && xhr.status < 300 && resp.ok) {
          item.msg.textContent = 'OK: ' + (resp.data?.nome_final || 'enviado');
          item.bar.style.width = '100%';
          item.li.classList.add('teal-text');
          item.status = 'enviado';
          enviados.add(item.key);
          updateSendButton();
        } else if (xhr.status === 422) {
          const det = resp.details ? ` (${resp.details})` : '';
          item.msg.textContent = 'Resolu√ß√£o reprovada' + det;
          item.li.classList.add('red-text');
        } else {
          item.msg.textContent = 'Erro: ' + (resp.message || ('HTTP '+xhr.status));
          item.li.classList.add('red-text');
        }
        resolve();
      };

      xhr.send(form);
    });
  }
  updateSendButton();
});

function updateSendButton(){
  const pendentes = queue.filter(it => it.status === 'pendente').length;
  const btn = document.getElementById('btnSend');
  btn.disabled = pendentes === 0;
  // opcional: mostrar quantidade no r√≥tulo
  // btn.innerHTML = `<i class="material-icons left">send</i> Enviar${pendentes ? ` (${pendentes})` : ''}`;
}

function wipeSession(){
  try {
    localStorage.removeItem(SESS_KEY);
    localStorage.removeItem('token');        // compat
    // limpa caches do navegador (se houver)
    if (window.caches && caches.keys) {
      caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
    }
  } catch(_) {}
}

function logout(){
  wipeSession();
  // volta para a tela de login
  location.replace('/redacaoenem/index.html');
}


</script>
</body>
</html>
